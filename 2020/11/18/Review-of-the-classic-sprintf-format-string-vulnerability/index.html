<!DOCTYPE html>
<!--[if lte IE 8 ]>
<html class="ie" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<![endif]-->
<!--[if (gte IE 9)|!(IE)]><!-->
<!--
***************  *      *     *
      8          *    *       *
      8          *  *         *
      8          **           *
      8          *  *         *
      8          *    *       *
      8          *      *     *
      8          *        *   ***********    -----Theme By Kieran(http://go.kieran.top)
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN" lang="zh-CN">
<!--<![endif]-->

<head>
  <title>Review of the classic sprintf format string vulnerability | s1mple</title>
  <!-- Meta data -->
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="s1mple">
    <meta name="author" content="s1mple">
    <meta name="description" content="" />
    <meta name="keywords" content="" />

    <!-- Favicon, (keep icon in root folder) -->
    <link rel="Shortcut Icon" href="/img/favicon.ico" type="image/ico">

    <link rel="alternate" href="/atom.xml" title="s1mple" type="application/atom+xml">
    <link rel="stylesheet" href="/css/all.css" media="screen" type="text/css">
    
    <link rel="stylesheet" href="/highlightjs/vs.css" type="text/css">
    

    <!--[if IE 8]>
    <link rel="stylesheet" type="text/css" href="/css/ie8.css" />
    <![endif]-->

    <!-- jQuery | Load our jQuery, with an alternative source fallback to a local version if request is unavailable -->
    <script src="/js/jquery-1.11.1.min.js"></script>
    <script>window.jQuery || document.write('<script src="js/jquery-1.11.1.min.js"><\/script>')</script>

    <!-- Load these in the <head> for quicker IE8+ load times -->
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="/js/html5shiv.min.js"></script>
    <script src="/js/respond.min.js"></script>
    <![endif]-->

  
  
  

  <style>.col-md-8.col-md-offset-2.opening-statement img{display:none;}</style>
</head>

<!--
<body class="post-template">
-->
<body id="index" class="lightnav animsition">

      <!-- ============================ Off-canvas navigation =========================== -->

    <div class="sb-slidebar sb-right sb-style-overlay sb-momentum-scrolling">
        <div class="sb-close" aria-label="Close Menu" aria-hidden="true">
            <img src="/img/close.png" alt="Close"/>
        </div>
        <!-- Lists in Slidebars -->
        <ul class="sb-menu">
            <li><a href="/" class="animsition-link" title="Home">Home</a></li>
            <li><a href="/archives" class="animsition-link" title="archive">archives</a></li>
            <!-- Dropdown Menu -->
			 
            <li>
                <a class="sb-toggle-submenu">Works<span class="sb-caret"></span></a>
                <ul class="sb-submenu">
                    
                        <li><a href="/" target="_BLANK" class="animsition-link"></a></li>
                    
                        <li><a href="/atom.xml" target="_BLANK" class="animsition-link"></a></li>
                    
                </ul>
            </li>
            
            
            
            <li>
                <a class="sb-toggle-submenu">Links<span class="sb-caret"></span></a>
                <ul class="sb-submenu">
                    
                    <li><a target="_blank" rel="noopener" href="https://blog.zeddyu.info/" class="animsition-link">陆队</a></li>
                    
                    <li><a target="_blank" rel="noopener" href="https://st4ck.gitee.io/" class="animsition-link">书鱼</a></li>
                    
                    <li><a target="_blank" rel="noopener" href="https://boluochuixue.top/" class="animsition-link">菠萝吹雪</a></li>
                    
                    <li><a target="_blank" rel="noopener" href="https://rmb122.com/" class="animsition-link">rmb</a></li>
                    
                </ul>
            </li>
            
        </ul>
        <!-- Lists in Slidebars -->
        <ul class="sb-menu secondary">
            
            <li><a href="/about.html" class="animsition-link" title="about">About</a></li>
            <li><a href="/atom.xml" class="animsition-link" title="rss">RSS</a></li>
        </ul>
    </div>
    
    <!-- ============================ END Off-canvas navigation =========================== -->

    <!-- ============================ #sb-site Main Page Wrapper =========================== -->

    <div id="sb-site">
        <!-- #sb-site - All page content should be contained within this id, except the off-canvas navigation itself -->

        <!-- ============================ Header & Logo bar =========================== -->

        <div id="navigation" class="navbar navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container">
                    <!-- Nav logo -->
                    <div class="logo">
                        <a href="/" title="Logo" class="animsition-link">
                         <img src="/img/logo.png" alt="Logo" width="35px;"/> 
                        </a>
                    </div>
                    <!-- // Nav logo -->
                    <!-- Info-bar -->
                    <nav>
                        <ul class="nav">
                            <li><a href="/" class="animsition-link">s1mple</a></li>
                            <li class="nolink"><span>Always </span>Creative.</li>
                            
                            <li><a href="https://github.com/" title="Github" target="_blank"><i class="icon-github"></i></a></li>
                            
                            
                            <li><a href="https://twitter.com/" title="Twitter" target="_blank"><i class="icon-twitter"></i></a></li>
                            
                            
                            <li><a href="https://www.facebook.com/" title="Facebook" target="_blank"><i class="icon-facebook"></i></a></li>
                            
                            
                            <li><a href="https://google.com/" title="Google-Plus" target="_blank"><i class="icon-google-plus"></i></a></li>
                            
                            
                            <li><a href="http://weibo.com/" title="Sina-Weibo" target="_blank"><i class="icon-sina-weibo"></i></a></li>
                            
                            <li class="nolink"><span>Welcome!</span></li>
                        </ul>
                    </nav>
                    <!--// Info-bar -->
                </div>
                <!-- // .container -->
                <div class="learnmore sb-toggle-right">More</div>
                <button type="button" class="navbar-toggle menu-icon sb-toggle-right" title="More">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar before"></span>
                <span class="icon-bar main"></span>
                <span class="icon-bar after"></span>
                </button>
            </div>
            <!-- // .navbar-inner -->
        </div>

        <!-- ============================ Header & Logo bar =========================== -->


      
<section id="intro">
    <div class="container">
        <div class="row col-md-offset-2">
            <div class="col-md-8">
    			<span class="post-meta">
      <time datetime="2020-11-18T05:04:55.000Z" itemprop="datePublished">
          2020-11-18
      </time>
    
</span>
                <h1>Review of the classic sprintf format string vulnerability</h1>
            </div>
        </div>
        <div class="col-md-8 col-md-offset-2">
      		<h2 id="Foreword"><a href="#Foreword" class="headerlink" title="Foreword"></a><strong>Foreword</strong></h2><p>​    抽时间帮助学校的队伍打了下上海大学生信息安全竞赛，题目质量还可以，最后ak了web题；有一道题利用sprintf经典格式化字符串漏洞进行逃逸单引号达到盲注的效果，最开始没想出来是这个点，后来本地测试了下发现是可以绕过的，发生在password处；</p>
<h2 id="text"><a href="#text" class="headerlink" title="text"></a><strong>text</strong></h2><p>sprintf函数将格式化的字符输入到变量中；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sprintf(format,arg1,arg2,arg++)</span><br></pre></td></tr></table></figure>

<p> arg1、arg2、++ 参数将被插入到主字符串中的百分号（%）符号处。该函数是逐步执行的。在第一个 % 符号处，插入 arg1，在第二个 % 符号处，插入 arg2，依此类推。 </p>
<p>下面举两个例子看：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">$s1mple = <span class="number">123</span>;</span><br><span class="line">$simple = sprintf(<span class="string">&quot;%f&quot;</span>,$s1mple);</span><br><span class="line"><span class="keyword">echo</span> $simple;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$s1mple =<span class="number">123</span>;</span><br><span class="line">$simple = sprintf(<span class="string">&quot;保留两位小数:%1\$.2f&quot;</span>&lt;br&gt;<span class="string">&quot;不带小数:%2\$u&quot;</span>,$s1mple);</span><br><span class="line"><span class="keyword">echo</span> $simple;</span><br></pre></td></tr></table></figure>

<p>这里因为我们百分号的数量大于我们需要传入参数的数量，所以这里需要使用占位符；占位符通常是由 数字<code>+&quot;\$&quot;</code>组成；</p>
<h2 id="The-complement-of-sprintf"><a href="#The-complement-of-sprintf" class="headerlink" title="The complement of sprintf"></a><strong>The complement of sprintf</strong></h2><p>鲜明的标志是补位符在单引号后面； ‘ 号（单引号）代表接下来要用补位类型</p>
<p>补位符有或者没有其实都问题不大；来看下面的两个对比的代码；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="string">&quot;abcdef&quot;</span>;</span><br><span class="line">$b = <span class="string">&quot;abcdef&quot;</span>;</span><br><span class="line"></span><br><span class="line">$c = <span class="string">&quot;1234&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> sprintf(<span class="string">&quot;%&#x27;9.2f&quot;</span>,$c);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    <span class="comment">//回显效果为1234.00</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="string">&quot;abcdef&quot;</span>;</span><br><span class="line">$b = <span class="string">&quot;abcdef&quot;</span>;</span><br><span class="line"></span><br><span class="line">$c = <span class="string">&quot;1234&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> sprintf(<span class="string">&quot;%&#x27;x9.2f&quot;</span>,$c);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    <span class="comment">//回显效果为xx1234.00</span></span><br></pre></td></tr></table></figure>

<p>通过这两个例子可以鲜明的对比，补位符只是起到了补充未够位数的作用，例子二就是拿x作为补位符；从而实现了x进行补位以达到例子二的输出效果；</p>
<h2 id="Causes-of-sprintf-format-string-vulnerability"><a href="#Causes-of-sprintf-format-string-vulnerability" class="headerlink" title="Causes of sprintf format string vulnerability"></a><strong>Causes of sprintf format string vulnerability</strong></h2><p>sprintf对未知格式的判断，造成的漏洞；先来看下文档，里面记述了sprintf可以采用那些格式：</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/DZ7AX9"><img src="https://s3.ax1x.com/2020/11/17/DZ7AX9.png" alt="DZ7AX9.png"></a></p>
<p>那么除了这些格式之外，php如果遇到了未知的格式，那么就会舍弃，这点在php底层源码中有体现；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> (format[inpos]) &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;s&#x27;</span>:</span><br><span class="line">    &#123;</span><br><span class="line">        zend_string * t;</span><br><span class="line">        zend_string * str = zval_get_tmp_string(tmp, &amp;t);</span><br><span class="line">        php_sprintf_appendstring( &amp; result, &amp;outpos, ZSTR_VAL(str), width, precision, padding, alignment, ZSTR_LEN(str), <span class="number">0</span>, expprec, <span class="number">0</span>);</span><br><span class="line">        zend_tmp_string_release(t);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;d&#x27;</span>:</span><br><span class="line">    php_sprintf_appendint( &amp; result, &amp;outpos, zval_get_long(tmp), width, padding, alignment, always_sign);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;u&#x27;</span>:</span><br><span class="line">    php_sprintf_appenduint( &amp; result, &amp;outpos, zval_get_long(tmp), width, padding, alignment);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;g&#x27;</span>:</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;G&#x27;</span>:</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;e&#x27;</span>:</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;E&#x27;</span>:</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;f&#x27;</span>:</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;F&#x27;</span>:</span><br><span class="line">    php_sprintf_appenddouble( &amp; result, &amp;outpos, zval_get_double(tmp), width, padding, alignment, precision, adjusting, format[inpos], always_sign);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;c&#x27;</span>:</span><br><span class="line">    php_sprintf_appendchar( &amp; result, &amp;outpos, (char) zval_get_long(tmp));</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;o&#x27;</span>:</span><br><span class="line">    php_sprintf_append2n( &amp; result, &amp;outpos, zval_get_long(tmp), width, padding, alignment, <span class="number">3</span>, hexchars, expprec);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;x&#x27;</span>:</span><br><span class="line">    php_sprintf_append2n( &amp; result, &amp;outpos, zval_get_long(tmp), width, padding, alignment, <span class="number">4</span>, hexchars, expprec);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;X&#x27;</span>:</span><br><span class="line">    php_sprintf_append2n( &amp; result, &amp;outpos, zval_get_long(tmp), width, padding, alignment, <span class="number">4</span>, HEXCHARS, expprec);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;b&#x27;</span>:</span><br><span class="line">    php_sprintf_append2n( &amp; result, &amp;outpos, zval_get_long(tmp), width, padding, alignment, <span class="number">1</span>, hexchars, expprec);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;%&#x27;</span>:</span><br><span class="line">    php_sprintf_appendchar( &amp; result, &amp;outpos, <span class="string">&#x27;%&#x27;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>底层源码中对sprintf可以处理的字符格式做了鲜明的处理方法，但是对未知的字符格式则是直接进行了break；那么就会出现舍弃字符的现象，最后会导致引号逃逸（后续细说</p>
<p>看如下的例子：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$s1mple = <span class="string">&#x27;aaa&#x27;</span>;</span><br><span class="line"><span class="keyword">echo</span> sprintf(<span class="string">&#x27;%1$s&#x27;</span>,$s1mple);  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>上述的例子可以正常地回显，但是如果我们传入一个未知的字符处理格式，那又会如何呢，在底层源码中我们可以发现，php会进行break从而舍弃；看下实例；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$s1mple = <span class="string">&#x27;aaa&#x27;</span>;</span><br><span class="line"><span class="keyword">echo</span> sprintf(<span class="string">&#x27;%1$as&#x27;</span>,$s1mple);  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>上述例子的回显效果为s；说明了我们前面的非法的字符格式已经被break了，也就是我们的%1$a被舍弃，所以直接输出了s；写如下例子：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$s1mple = <span class="string">&#x27;aaa&#x27;</span>;</span><br><span class="line"><span class="keyword">echo</span> sprintf(<span class="string">&#x27;%1$a%s&#x27;</span>,$s1mple);  </span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们看到如上的例子，会输出aaa，不难分析，因为我们前面的非法处理类型遭到的break舍弃，所以只剩下%s，所以自然正确的格式化输出了aaa；</p>
<p>这里如果将我们的非法格式化类型换成数字，那么也就是规范的格式化，因为%1$10s表示的是最后格式化第一个参数，接着保留十位字符，格式为字符串；这里不在过多的赘述；这种写法也就和之前讲的填充字符结合到一起了；因为位数不够的时候自然是需要进行填充，但是也可以没有填充字符，没有的时候默认是用空格进行填充；</p>
<h1 id="Vulnerability-description"><a href="#Vulnerability-description" class="headerlink" title="Vulnerability description"></a><strong>Vulnerability description</strong></h1><p>经过我们上述的描述，我们会发现sprintf会进行字符的break；并且没有对字符有任何危险的处理，就简单的break；那么漏洞的点就是在这里触发；</p>
<h2 id="SQL-injection-quotation-mark-escape-caused-by-sprintf"><a href="#SQL-injection-quotation-mark-escape-caused-by-sprintf" class="headerlink" title="SQL injection quotation mark escape caused by sprintf"></a><strong>SQL injection quotation mark escape caused by sprintf</strong></h2><p>来看如下的代码；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//addslashes()函数：在预定义前面加反斜杠，预定义符有单引号（&#x27;），双引号（&quot;），反斜杠（\），NULL</span></span><br><span class="line">$input = addslashes (<span class="string">&quot;%1$&#x27; and 1=1#&quot;</span> );</span><br><span class="line"><span class="comment">//输出为   %1$\&#x27; and 1=1#</span></span><br><span class="line">$b = sprintf (<span class="string">&quot;AND b=&#x27;%s&#x27;&quot;</span>, $input );</span><br><span class="line"><span class="comment">//输出为  AND b=&#x27;%1$\&#x27; and 1=1#&#x27;</span></span><br><span class="line">$sql = sprintf (<span class="string">&quot;SELECT * FROM t WHERE a=&#x27;%s&#x27; <span class="subst">$b</span> &quot;</span>, <span class="string">&#x27;admin&#x27;</span> );</span><br><span class="line"><span class="keyword">echo</span>  $sql ;</span><br><span class="line"><span class="comment">//输出为  SELECT * FROM t WHERE a=&#x27;admin&#x27; AND b=&#x27;&#x27; and 1=1#&#x27;</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>通过这个例子我们可以看到，因为经过了addslashes函数的处理，我们的引号前会被默认的加入反斜杠进行转移，但是我们反斜杠在sprintf函数中可以错误引用从而被break掉；没有了反斜杠的转义，我们的引号自然会逃逸出来；从而进行sql的闭合达到sql injection；</p>
<h2 id="Another-interesting-tirck"><a href="#Another-interesting-tirck" class="headerlink" title="Another interesting tirck"></a><strong>Another interesting tirck</strong></h2><p>构造单引号，利用sprintf的格式化特性，可以进行单引号的引入；简单来说如果后面格式化的参数为数字的话，我们可以通过%c来引入进行转码，从而进入单引号，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="number">39</span>;</span><br><span class="line">$b = sprintf(<span class="string">&#x27;%c&#x27;</span>,$a);</span><br><span class="line"><span class="keyword">echo</span> $b;</span><br><span class="line"><span class="comment">//输出结果为 &#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这种类型在有些专门设计的sql注入题中会有出现；简单的提一下，当作一个分享；</p>
<h2 id="Application-point-of-sprintf-format-string-in-actual-combat"><a href="#Application-point-of-sprintf-format-string-in-actual-combat" class="headerlink" title="Application point of sprintf format string in actual combat"></a><strong>Application point of sprintf format string in actual combat</strong></h2><p>上海大学生信息安全竞赛的web2，是一个sql注入，盲注；漏洞点发生在class.php中</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$sql=<span class="string">&quot;select * from user where username=&#x27;%s&#x27; andpassword=&#x27;<span class="subst">$password</span>&#x27;&quot;</span>;</span><br><span class="line">$sql=sprintf($sql,$username);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>通过表单提交username和password，然后后续php代码处理，发现sql中格式化输入了username，这里并没有漏洞点可利用，但是password是没有经过格式化传入的，我们可以在password处利用非法的字符格式使其break掉，然后逃逸出单引号；因为传入的数据经过了addslashes;所以漏洞利用就更加明显了，直接嵌入  %1$’ || 1=1#;</p>
<p>这里经过aaddslashes函数处理之后，会在单引号前加入反斜杠，那么对于sprintf函数那就成了非法的字符格式，根据底层代码实现，会将其整体break；最后也就自然留下了单引号；然后闭合进行注入；</p>
<p>贴上一张在比赛时候的盲注测试图：</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/DZ79YT"><img src="https://s3.ax1x.com/2020/11/17/DZ79YT.png" alt="DZ79YT.png"></a></p>
<p>回显登陆正确；原因看如下测试图：</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/DZ7CfU"><img src="https://s3.ax1x.com/2020/11/17/DZ7CfU.png" alt="DZ7CfU.png"></a></p>
<p>可以让单引号逃逸出来，一个简单的分析，不是很难理解；</p>
<h2 id="WordPress-format-string-vulnerability-analysis"><a href="#WordPress-format-string-vulnerability-analysis" class="headerlink" title="WordPress format string vulnerability analysis"></a>WordPress format string vulnerability analysis</h2><p>这个漏洞比较的老版，版本需要小于4.7.5，经过测试在4.7.5中已经做了修补；现实的攻击意义不大，但是还是讲述一下；首先漏洞发生在删除图片的地方；</p>
<p>从upload.php处入手，发现post_id_del未经过任何处理就进入了程序的运作；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;delete&#x27;</span>:</span><br><span class="line">		<span class="keyword">if</span> ( !<span class="keyword">isset</span>( $post_ids ) )</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">foreach</span> ( (<span class="keyword">array</span>) $post_ids <span class="keyword">as</span> $post_id_del ) &#123;</span><br><span class="line">			<span class="keyword">if</span> ( !current_user_can( <span class="string">&#x27;delete_post&#x27;</span>, $post_id_del ) )</span><br><span class="line">				wp_die( __( <span class="string">&#x27;Sorry, you are not allowed to delete this item.&#x27;</span> ) );</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> ( !wp_delete_attachment( $post_id_del ) )</span><br><span class="line">				wp_die( __( <span class="string">&#x27;Error in deleting.&#x27;</span> ) );</span><br><span class="line">		&#125;</span><br><span class="line">		$location = add_query_arg( <span class="string">&#x27;deleted&#x27;</span>, count( $post_ids ), $location );</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="comment">/** This action is documented in wp-admin/edit-comments.php */</span></span><br><span class="line">		$location = apply_filters( <span class="string">&#x27;handle_bulk_actions-&#x27;</span> . get_current_screen()-&gt;id, $location, $doaction, $post_ids );</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>看到delete选块，简单理解代码，提交需要删除图片的id；然后进行权限检查，然后进入了一个未知的wp_delete_attachment函数，追踪函数，在post.php中发现了函数的定义；并且调用了个 delete_metadata 函数，</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/DZ7Fl4"><img src="https://s3.ax1x.com/2020/11/17/DZ7Fl4.png" alt="DZ7Fl4.png"></a></p>
<p>继续跟进delete_metadata函数； 漏洞触发点主要在wp-includes/meta.php 的 delete_metadata函数里面 ；</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/DZ7j3D"><img src="https://s3.ax1x.com/2020/11/17/DZ7j3D.png" alt="DZ7j3D.png"></a></p>
<p>发现调用了prepare函数，继续跟进函数发现有段操作；贴出来；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$query = str_replace( <span class="string">&quot;&#x27;%s&#x27;&quot;</span>, <span class="string">&#x27;%s&#x27;</span>, $query ); <span class="comment">// in case someone mistakenly already singlequoted it</span></span><br><span class="line">		$query = str_replace( <span class="string">&#x27;&quot;%s&quot;&#x27;</span>, <span class="string">&#x27;%s&#x27;</span>, $query ); <span class="comment">// doublequote unquoting</span></span><br><span class="line">		$query = preg_replace( <span class="string">&#x27;|(?&lt;!%)%f|&#x27;</span> , <span class="string">&#x27;%F&#x27;</span>, $query ); <span class="comment">// Force floats to be locale unaware</span></span><br><span class="line">		$query = preg_replace( <span class="string">&#x27;|(?&lt;!%)%s|&#x27;</span>, <span class="string">&quot;&#x27;%s&#x27;&quot;</span>, $query ); <span class="comment">// quote the strings, avoiding escaped strings like %%s</span></span><br><span class="line">array_walk( $args, <span class="keyword">array</span>( <span class="keyword">$this</span>, <span class="string">&#x27;escape_by_ref&#x27;</span> ) );</span><br><span class="line">		<span class="keyword">return</span> @vsprintf( $query, $args );</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里分析一下，先将’%s’ 替换成了 %s 然后将 “%s”题换成了 %s 然后强制转化为浮点%F，把%s替换为’%s’,最后进行vsprintf格式化输入然后return；</p>
<p>我们拉到本地进行复现下 </p>
<p>加入我们传入的meta_value 为 admin’   进入这个语句；$wpdb-&gt;prepare( “ AND meta_value = %s”, $meta_value ); </p>
<p>query经过prepare处理之后，最终变成 vsprintf(“ AND meta_value = ‘’%s’”, $meta_value);所以这里直接拼接后得到 and meta_value = ‘admin’;再return后；经过prepare函数处理后再得到；vsprintf( “SELECT $type_column FROM $table WHERE meta_key = ‘%s’ AND meta_value = ‘admin’”,’admin’)=&gt; SELECT $type_column FROM $table WHERE meta_key = ‘admin’ AND meta_value = ‘admin’；语句无错误；</p>
<p>但是我们来看一下我们可控变量的走向； <code>$post_id_del =&gt; $post_id =&gt; $meta_value =&gt; $args =&gt; $query </code></p>
<p>我们再回顾一下str_replace的替换，有一处是将’%s’替换为%s，然后再最后的时候又将%s替换成了’%s’，所以这两次替换没有什么实质性的干扰；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( <span class="string">&#x27;&#x27;</span> !== $meta_value &amp;&amp; <span class="literal">null</span> !== $meta_value &amp;&amp; <span class="literal">false</span> !== $meta_value ) &#123;</span><br><span class="line">			$value_clause = $wpdb-&gt;prepare( <span class="string">&quot; AND meta_value = %s&quot;</span>, $meta_value );</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		$object_ids = $wpdb-&gt;get_col( $wpdb-&gt;prepare( <span class="string">&quot;SELECT <span class="subst">$type_column</span> FROM <span class="subst">$table</span> WHERE meta_key = %s <span class="subst">$value_clause</span>&quot;</span>, $meta_key ) );</span><br><span class="line">	&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里我们看处理后的一段流程，先进行了一次prepare处理，，然后再次经过prepare处理之后进行二次拼接，这里我们可控的变量再二次拼接的时候依然是可控的，那么我们如果想造成sql注入，那么这里就需要引入引号，让其再$value_clause处进行闭合，然后执行sql语句；</p>
<p>本地测试，经过第一次替换之后，$value_clause为  AND meta_value = ‘$meta_value’;如下图所示；</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/DZ7k6J"><img src="https://s3.ax1x.com/2020/11/17/DZ7k6J.png" alt="DZ7k6J.png"></a></p>
<p>然后第二次替换的时候我们可以想办法引入引号，引号的引入就在我们的prepare函数的处理方式处，其处理将%s替换为’%s’；这里就是我们引号的引入点，看如下实例分析；</p>
<p>这里如果我们引入一个非法的字符格式进行处理；在文章的最开始就讲述了非法的字符格式会被break掉，那么我们这里就可以利用；如果我们传入 <code>%1$%s AND SLEEP(5)#</code>；这里引入的很巧妙，因为进行了替换的原因，我们在第二次的prepare处会变成  <code>%1$&#39;%s&#39; AND SLEEP(5)#</code>;这里由于发生了替换导致<code>%1$&#39;</code>成为了非法的字符格式；从而导致其被break掉，那么只剩下%s;我们后边的引号自然的会逃逸出来，进行闭合，然后and sleep进行时间延迟；</p>
<p>其实这个漏洞言简意赅的总结一下，也就是利用vsprintf格式化字符串引入前后引号，然后利用非法的字符格式break掉前引号，然后后引号直接闭合继续后面拼接and sleep进行延时，sleep后的引号是再第一次的prepare处引入的，所以利用的很完美，造成时间延迟，可以进行注入；</p>

            <div class="clearfix"></div>
            <hr class="nogutter">
        </div>
        <nav class="m-pagination col-md-8 col-md-offset-2 col-sm-24" role="pagination">
    
    <a class="pull-left" href="/2020/11/18/file-put-content%E5%92%8C%E6%AD%BB%E4%BA%A1%C2%B7%E6%9D%82%E7%B3%85%E4%BB%A3%E7%A0%81%E4%B9%8B%E7%BC%98/" style="float: left;">
        ← file_put_content和死亡·杂糅代码之缘
    </a>
    
    
</nav>

        <div class="col-md-8 col-md-offset-2 col-sm-24"><script type="text/javascript">
  /**
   * 搜狐畅言
   */

  /*
  document.write('<div id="SOHUCS" sid="' + window.location.pathname.slice(1) + '" ></div>');

  window.onload = function () {
    (function () {
      var appid = 'cytXXXX';
      var conf = 'prod_xxxxxxxxxxxxxxxxx';
      var width = window.innerWidth || document.documentElement.clientWidth;
      var loadJs = function (d, a, id) {
        var c = document.getElementsByTagName("head")[0] || document.head || document.documentElement;
        var b = document.createElement("script");
        b.setAttribute("type", "text/javascript");
        b.setAttribute("charset", "UTF-8");
        b.setAttribute("src", d);
        if (id) {
          b.setAttribute("id", id);
        }
        if (typeof a === "function") {
          if (window.attachEvent) {
            b.onreadystatechange = function () {
              var e = b.readyState;
              if (e === "loaded" || e === "complete") {
                b.onreadystatechange = null;
                a()
              }
            }
          } else {
            b.onload = a
          }
        }
        c.appendChild(b)
      };

      loadJs("https://changyan.sohu.com/upload/changyan.js", function () {
        window.changyan.api.config({
          appid: appid,
          conf: conf
        })
      });
    })();
  }
  */

</script>
</div>
    </div>
</section>


      
<!-- ============================ Footer =========================== -->

<footer>
    <div class="container">
            <div class="copy">
                <p>
                    &copy; 2014<script>new Date().getFullYear()>2010&&document.write("-"+new Date().getFullYear());</script>, Content By s1mple. All Rights Reserved.
                </p>
                <p>Theme By <a target="_blank" rel="noopener" href="//go.kieran.top" style="color: #767D84">Kieran</a></p>
            </div>
            <div class="social">
                <ul>
                    
                    <li><a href="https://github.com/" title="Github" target="_blank"><i class="icon-github"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="https://twitter.com/" title="Twitter" target="_blank"><i class="icon-twitter"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="https://www.facebook.com/" title="Facebook" target="_blank"><i class="icon-facebook"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="https://google.com/" title="Google-Plus" target="_blank"><i class="icon-google-plus"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="http://weibo.com/" title="Sina-Weibo" target="_blank"><i class="icon-sina-weibo"></i></a>&nbsp;</li>
                    
                </ul>
            </div>
            <div class="clearfix"> </div>
        </div>
</footer>

<!-- ============================ END Footer =========================== -->
      <!-- Load our scripts -->
<!-- Resizable 'on-demand' full-height hero -->
<script type="text/javascript">
    var resizeHero = function () {
        var hero = $(".cover,.heightblock"),
            window1 = $(window);
        hero.css({
            "height": window1.height()
        });
    };

    resizeHero();

    $(window).resize(function () {
        resizeHero();
    });
</script>
<script src="/js/plugins.min.js"></script><!-- Bootstrap core and concatenated plugins always load here -->
<script src="/js/scripts.js"></script><!-- Theme scripts -->


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$('#intro').find('img').each(function(){
  var alt = this.alt;

  if (alt){
    $(this).after('<span class="caption" style="display:none">' + alt + '</span>');
  }

  $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox" rel="gallery" />');
});
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



      
</body>
</html>
