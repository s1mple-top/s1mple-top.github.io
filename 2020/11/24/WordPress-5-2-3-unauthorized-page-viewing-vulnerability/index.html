<!DOCTYPE html>
<!--[if lte IE 8 ]>
<html class="ie" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<![endif]-->
<!--[if (gte IE 9)|!(IE)]><!-->
<!--
***************  *      *     *
      8          *    *       *
      8          *  *         *
      8          **           *
      8          *  *         *
      8          *    *       *
      8          *      *     *
      8          *        *   ***********    -----Theme By Kieran(http://go.kieran.top)
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN" lang="zh-CN">
<!--<![endif]-->

<head>
  <title>WordPress 5.2.3 unauthorized page viewing vulnerability | s1mple</title>
  <!-- Meta data -->
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="s1mple">
    <meta name="author" content="s1mple">
    <meta name="description" content="" />
    <meta name="keywords" content="" />

    <!-- Favicon, (keep icon in root folder) -->
    <link rel="Shortcut Icon" href="/img/favicon.ico" type="image/ico">

    <link rel="alternate" href="/atom.xml" title="s1mple" type="application/atom+xml">
    <link rel="stylesheet" href="/css/all.css" media="screen" type="text/css">
    
    <link rel="stylesheet" href="/highlightjs/vs.css" type="text/css">
    

    <!--[if IE 8]>
    <link rel="stylesheet" type="text/css" href="/css/ie8.css" />
    <![endif]-->

    <!-- jQuery | Load our jQuery, with an alternative source fallback to a local version if request is unavailable -->
    <script src="/js/jquery-1.11.1.min.js"></script>
    <script>window.jQuery || document.write('<script src="js/jquery-1.11.1.min.js"><\/script>')</script>

    <!-- Load these in the <head> for quicker IE8+ load times -->
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="/js/html5shiv.min.js"></script>
    <script src="/js/respond.min.js"></script>
    <![endif]-->

  
  
  

  <style>.col-md-8.col-md-offset-2.opening-statement img{display:none;}</style>
</head>

<!--
<body class="post-template">
-->
<body id="index" class="lightnav animsition">

      <!-- ============================ Off-canvas navigation =========================== -->

    <div class="sb-slidebar sb-right sb-style-overlay sb-momentum-scrolling">
        <div class="sb-close" aria-label="Close Menu" aria-hidden="true">
            <img src="/img/close.png" alt="Close"/>
        </div>
        <!-- Lists in Slidebars -->
        <ul class="sb-menu">
            <li><a href="/" class="animsition-link" title="Home">Home</a></li>
            <li><a href="/archives" class="animsition-link" title="archive">archives</a></li>
            <!-- Dropdown Menu -->
			 
            <li>
                <a class="sb-toggle-submenu">Works<span class="sb-caret"></span></a>
                <ul class="sb-submenu">
                    
                        <li><a href="/" target="_BLANK" class="animsition-link"></a></li>
                    
                        <li><a href="/atom.xml" target="_BLANK" class="animsition-link"></a></li>
                    
                </ul>
            </li>
            
            
            
            <li>
                <a class="sb-toggle-submenu">Links<span class="sb-caret"></span></a>
                <ul class="sb-submenu">
                    
                    <li><a target="_blank" rel="noopener" href="https://blog.zeddyu.info/" class="animsition-link">陆队</a></li>
                    
                    <li><a target="_blank" rel="noopener" href="https://st4ck.gitee.io/" class="animsition-link">书鱼</a></li>
                    
                    <li><a target="_blank" rel="noopener" href="https://boluochuixue.top/" class="animsition-link">菠萝吹雪</a></li>
                    
                    <li><a target="_blank" rel="noopener" href="https://rmb122.com/" class="animsition-link">rmb</a></li>
                    
                </ul>
            </li>
            
        </ul>
        <!-- Lists in Slidebars -->
        <ul class="sb-menu secondary">
            
            <li><a href="/about.html" class="animsition-link" title="about">About</a></li>
            <li><a href="/atom.xml" class="animsition-link" title="rss">RSS</a></li>
        </ul>
    </div>
    
    <!-- ============================ END Off-canvas navigation =========================== -->

    <!-- ============================ #sb-site Main Page Wrapper =========================== -->

    <div id="sb-site">
        <!-- #sb-site - All page content should be contained within this id, except the off-canvas navigation itself -->

        <!-- ============================ Header & Logo bar =========================== -->

        <div id="navigation" class="navbar navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container">
                    <!-- Nav logo -->
                    <div class="logo">
                        <a href="/" title="Logo" class="animsition-link">
                         <img src="/img/logo.png" alt="Logo" width="35px;"/> 
                        </a>
                    </div>
                    <!-- // Nav logo -->
                    <!-- Info-bar -->
                    <nav>
                        <ul class="nav">
                            <li><a href="/" class="animsition-link">s1mple</a></li>
                            <li class="nolink"><span>Always </span>Creative.</li>
                            
                            <li><a href="https://github.com/" title="Github" target="_blank"><i class="icon-github"></i></a></li>
                            
                            
                            <li><a href="https://twitter.com/" title="Twitter" target="_blank"><i class="icon-twitter"></i></a></li>
                            
                            
                            <li><a href="https://www.facebook.com/" title="Facebook" target="_blank"><i class="icon-facebook"></i></a></li>
                            
                            
                            <li><a href="https://google.com/" title="Google-Plus" target="_blank"><i class="icon-google-plus"></i></a></li>
                            
                            
                            <li><a href="http://weibo.com/" title="Sina-Weibo" target="_blank"><i class="icon-sina-weibo"></i></a></li>
                            
                            <li class="nolink"><span>Welcome!</span></li>
                        </ul>
                    </nav>
                    <!--// Info-bar -->
                </div>
                <!-- // .container -->
                <div class="learnmore sb-toggle-right">More</div>
                <button type="button" class="navbar-toggle menu-icon sb-toggle-right" title="More">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar before"></span>
                <span class="icon-bar main"></span>
                <span class="icon-bar after"></span>
                </button>
            </div>
            <!-- // .navbar-inner -->
        </div>

        <!-- ============================ Header & Logo bar =========================== -->


      
<section id="intro">
    <div class="container">
        <div class="row col-md-offset-2">
            <div class="col-md-8">
    			<span class="post-meta">
      <time datetime="2020-11-24T14:29:09.000Z" itemprop="datePublished">
          2020-11-24
      </time>
    
</span>
                <h1>WordPress 5.2.3 unauthorized page viewing vulnerability</h1>
            </div>
        </div>
        <div class="col-md-8 col-md-offset-2">
      		<h2 id="FOREWORD"><a href="#FOREWORD" class="headerlink" title="FOREWORD"></a><strong>FOREWORD</strong></h2><p>wordpress5.2.3存在未授权页面访问漏洞，攻击者可以通过这种漏洞观看到受害者得所有敏感文件；包括隐私文件和加密文件；</p>
<h2 id="text"><a href="#text" class="headerlink" title="text"></a><strong>text</strong></h2><p>首先声明，此漏洞可以未授权访问页面，但是不能未授权访问文章；本地复现可以通过下载wp源码然后在phpstudy中自行搭建；在new的地方选择page，而不是post；</p>
<h2 id="Vulnerability-analysis"><a href="#Vulnerability-analysis" class="headerlink" title="Vulnerability analysis"></a><strong>Vulnerability analysis</strong></h2><p>首先进入wp-includes/class-wp.php中；有个WP的类；该类是处理框架环境变量的地方，可以看到其定义了公有和私有的查询变量等等，</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/Dw2GcQ"><img src="https://s3.ax1x.com/2020/11/26/Dw2GcQ.png" alt="Dw2GcQ.png"></a></p>
<p>然后在类的结束地方，有一个main函数定义，该main函数调用了各个方法</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/Dw2tns"><img src="https://s3.ax1x.com/2020/11/26/Dw2tns.png" alt="Dw2tns.png"></a></p>
<p>在环境初始化的时候，会先调用WP类，将其实例化，然后利用main去调用相应的方法；从而去设置环境变量；看到在main中调用了parse_request方法；回溯一下；</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/Dw2JXj"><img src="https://s3.ax1x.com/2020/11/26/Dw2JXj.png" alt="Dw2JXj.png"></a></p>
<p>发现class WP中定义了这个方法；其作用是：解析  (GET/POST)   请求以找到正确的WordPress查询。根据请求设置查询变量。 还有很多可用于进一步处理结果的过滤器和操作；</p>
<p>继续审计，进入一个敏感的foreach方法；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span> ( <span class="keyword">$this</span>-&gt;public_query_vars <span class="keyword">as</span> $wpvar ) &#123;</span><br><span class="line">			<span class="keyword">if</span> ( <span class="keyword">isset</span>( <span class="keyword">$this</span>-&gt;extra_query_vars[ $wpvar ] ) ) &#123;</span><br><span class="line">				<span class="keyword">$this</span>-&gt;query_vars[ $wpvar ] = <span class="keyword">$this</span>-&gt;extra_query_vars[ $wpvar ];</span><br><span class="line">			&#125; <span class="keyword">elseif</span> ( <span class="keyword">isset</span>( $_GET[ $wpvar ] ) &amp;&amp; <span class="keyword">isset</span>( $_POST[ $wpvar ] ) &amp;&amp; $_GET[ $wpvar ] !== $_POST[ $wpvar ] ) &#123;</span><br><span class="line">				wp_die( __( <span class="string">&#x27;A variable mismatch has been detected.&#x27;</span> ), __( <span class="string">&#x27;Sorry, you are not allowed to view this item.&#x27;</span> ), <span class="number">400</span> );</span><br><span class="line">			&#125; <span class="keyword">elseif</span> ( <span class="keyword">isset</span>( $_POST[ $wpvar ] ) ) &#123;</span><br><span class="line">				<span class="keyword">$this</span>-&gt;query_vars[ $wpvar ] = $_POST[ $wpvar ];</span><br><span class="line">			&#125; <span class="keyword">elseif</span> ( <span class="keyword">isset</span>( $_GET[ $wpvar ] ) ) &#123;</span><br><span class="line">				<span class="keyword">$this</span>-&gt;query_vars[ $wpvar ] = $_GET[ $wpvar ];</span><br><span class="line">			&#125; <span class="keyword">elseif</span> ( <span class="keyword">isset</span>( $perma_query_vars[ $wpvar ] ) ) &#123;</span><br><span class="line">				<span class="keyword">$this</span>-&gt;query_vars[ $wpvar ] = $perma_query_vars[ $wpvar ];</span><br><span class="line">			&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>发现其遍历了公共变量，因为extra_query_vars最开始赋值的时候是个空数组；所以第一个if自然绕过，然后进入elseif；这个条件；第一个elseif满足的时候，直接die掉，并且返回400；不满足进入下一步，获取我们POST或者GET传入的数据；如果有的话就将其纳入我们的环境参数变量中；</p>
<p>假如我们传入如下的paylaod：<code>http://127.0.0.1/wordpress/?static=0&amp;order=asc&amp;s1mple=test</code></p>
<p>由我们比对可知，public_query_vars中存在static和order；并且我们GET请求的参数中也有，那么会将我们的这两个变量纳入到我们的环境变量中；也就是将其赋值给<code>query_vars[ static ]</code>和<code>query_vars[ order ]</code>；因为我们的public_query_vars中没有s1mple变量，所以这里不做处理；(主要点还是在系统自己设置的环境变量中)；</p>
<h2 id="Vulnerability-trigger-point"><a href="#Vulnerability-trigger-point" class="headerlink" title="Vulnerability trigger point"></a><strong>Vulnerability trigger point</strong></h2><p>差不多分析完了环境变量机制之后，来分析下漏洞的成因；</p>
<p>首发点在 <code>\wp-includes\class-wp-query.php </code></p>
<p>此页中有个parse_query的方法；此方法也是在wp启动的时候被调用的，只不过在parse_requests方法之后，也就是在设置好环境变量之后才被调用；</p>
<p>我们请求如下的payload：<code>http://127.0.0.1/wordpress/?static=0&amp;order=asc </code></p>
<p>首先分析数据流经过的处理，首先我们之前先进入parse_request函数进行处理；处理完之后我们上面也说到随后才是parse_query的方法；在我们parse_request方法中，我们发现query_vars是被定义成了一个数组，然后再WP_Query中也是顺接着被定义成了一个数组，我们WP_Query类中的query_vars变量因为来自于parse_request方法处理之后，所以其返回的效果应该是一个数组；Array(“static”=&gt;”0”,”order”=&gt;”asc”);</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/Dw2U7q"><img src="https://s3.ax1x.com/2020/11/26/Dw2U7q.png" alt="Dw2U7q.png"></a></p>
<p>回到parse_query方法中如上图，发现qv变量获取了query_vars的值，在此之前query_vars的值经过了<code>fill_query_vars</code>函数的处理；回溯一下；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fill_query_vars</span>(<span class="params"> $array </span>) </span>&#123;</span><br><span class="line">		$keys = <span class="keyword">array</span>(</span><br><span class="line">			<span class="string">&#x27;error&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;m&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;p&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;post_parent&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;subpost&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;subpost_id&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;attachment&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;attachment_id&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;name&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;static&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;pagename&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;page_id&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;second&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;minute&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;hour&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;day&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;monthnum&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;year&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;w&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;category_name&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;tag&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;cat&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;tag_id&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;author&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;author_name&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;feed&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;tb&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;paged&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;meta_key&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;meta_value&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;preview&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;s&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;sentence&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;title&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;fields&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;menu_order&#x27;</span>,</span><br><span class="line">			<span class="string">&#x27;embed&#x27;</span>,</span><br><span class="line">		);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">foreach</span> ( $keys <span class="keyword">as</span> $key ) &#123;</span><br><span class="line">			<span class="keyword">if</span> ( ! <span class="keyword">isset</span>( $array[ $key ] ) ) &#123;</span><br><span class="line">				$array[ $key ] = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<p>发现<code>fill_query_vars</code>方法回显遍历数组中的值，如果没有，就将其值置为空；但是我们这里请求的两个query；所以会给我们两个参数进行赋值；最后的效果就会是：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">$keys = <span class="keyword">array</span>(</span><br><span class="line">	<span class="string">&#x27;order&#x27;</span>=<span class="string">&#x27;asc&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;static&#x27;</span>=<span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;error&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;m&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;p&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;post_parent&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;subpost&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;subpost_id&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;attachment&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;attachment_id&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;name&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;static&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;pagename&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;page_id&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;second&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;minute&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;hour&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;day&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;monthnum&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;year&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;w&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;category_name&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;tag&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;cat&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;tag_id&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;author&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;author_name&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;feed&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;tb&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;paged&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;meta_key&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;meta_value&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;preview&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;s&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;sentence&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;title&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;fields&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;menu_order&#x27;</span>,</span><br><span class="line">	<span class="string">&#x27;embed&#x27;</span>,</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>经过fill_query_vars函数处理之后，最后赋值给qv变量，所以最后qv变量就为上处代码内容；即如果没有query变量得话，就会调用init方法，进行初始化，然后最后经过fill</p>
<p>继续向下审计：进入if函数；经过很多的if判断和处理，最后关键的代码在805行；如下图：</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/Dw281g"><img src="https://s3.ax1x.com/2020/11/26/Dw281g.png" alt="Dw281g.png"></a></p>
<p>我们传入了static参量使其不为空；所以我们会将is_page赋值为true；将is_single赋值为false；这里page就是页面的意思；所以这个if长语句就是用static，pagename，page_id这几个变量来判断是否需要进行page操作；这里我们传入static为0；显然是让程序将is_page赋值为true从而进行页面操作；继续向下审计；有关键的代码：</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/Dw2dA0"><img src="https://s3.ax1x.com/2020/11/26/Dw2dA0.png" alt="Dw2dA0.png"></a></p>
<p>这里审计下if语句，因为我们之前已经通过操作让is_page为true，让is_single为false；所以<code>$this-&gt;is_single || $this-&gt;is_page</code>恒为真；所以我们只需要操作让posts不为空，那么就可以进入if下的函数；先来回溯下posts的来源：看如下代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;request = $old_request = <span class="string">&quot;SELECT <span class="subst">$found_rows</span> <span class="subst">$distinct</span> <span class="subst">$fields</span> FROM <span class="subst">&#123;$wpdb-&gt;posts&#125;</span> <span class="subst">$join</span> WHERE 1=1 <span class="subst">$where</span> <span class="subst">$groupby</span> <span class="subst">$orderby</span> <span class="subst">$limits</span>&quot;</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ( ! $q[<span class="string">&#x27;suppress_filters&#x27;</span>] ) &#123;</span><br><span class="line">			<span class="comment">/**</span></span><br><span class="line"><span class="comment">			 * Filters the completed SQL query before sending.</span></span><br><span class="line"><span class="comment">			 *</span></span><br><span class="line"><span class="comment">			 * <span class="doctag">@since</span> 2.0.0</span></span><br><span class="line"><span class="comment">			 *</span></span><br><span class="line"><span class="comment">			 * <span class="doctag">@param</span> string   $request The complete SQL query.</span></span><br><span class="line"><span class="comment">			 * <span class="doctag">@param</span> WP_Query $this    The WP_Query instance (passed by reference).</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="keyword">$this</span>-&gt;request = apply_filters_ref_array( <span class="string">&#x27;posts_request&#x27;</span>, <span class="keyword">array</span>( <span class="keyword">$this</span>-&gt;request, &amp;<span class="keyword">$this</span> ) );</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 *</span></span><br><span class="line"><span class="comment">		 * <span class="doctag">@since</span> 4.6.0</span></span><br><span class="line"><span class="comment">		 *</span></span><br><span class="line"><span class="comment">		 * <span class="doctag">@param</span> array|null $posts Return an array of post data to short-circuit WP&#x27;s query,</span></span><br><span class="line"><span class="comment">		 *                          or null to allow WP to run its normal queries.</span></span><br><span class="line"><span class="comment">		 * <span class="doctag">@param</span> WP_Query   $this  The WP_Query instance (passed by reference).</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">$this</span>-&gt;posts = apply_filters_ref_array( <span class="string">&#x27;posts_pre_query&#x27;</span>, <span class="keyword">array</span>( <span class="literal">null</span>, &amp;<span class="keyword">$this</span> ) );</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ( <span class="string">&#x27;ids&#x27;</span> == $q[<span class="string">&#x27;fields&#x27;</span>] ) &#123;</span><br><span class="line">			<span class="keyword">if</span> ( <span class="literal">null</span> === <span class="keyword">$this</span>-&gt;posts ) &#123;</span><br><span class="line">				<span class="keyword">$this</span>-&gt;posts = $wpdb-&gt;get_col( <span class="keyword">$this</span>-&gt;request );</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">$this</span>-&gt;posts      = array_map( <span class="string">&#x27;intval&#x27;</span>, <span class="keyword">$this</span>-&gt;posts );</span><br><span class="line">			<span class="keyword">$this</span>-&gt;post_count = count( <span class="keyword">$this</span>-&gt;posts );</span><br><span class="line">			<span class="keyword">$this</span>-&gt;set_found_posts( $q, $limits );</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;posts;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里分析下。直接一个sql查询将我们的回显结果给了request;然后经过一个if判断，我们查询的语句中查询参数是没有suppress_filters参量的，所以我们这里直接过if判断，进入下面的处理；下面我们可以简单的理解为创建了一个过滤器钩子；然后接着进入下面的if判断语句，因为我们没有fields参量，所以我们直接过if；进入下面，array_map函数处理之后就赋值给了psots；下面的处理也可以暂时不用管，最后发现是return了posts；然后这里分析一下request的查询语句；</p>
<p>这里看到了这个sql语句是经过了很多变量拼接而成，那么我们回溯下相关的变量，$where在2406行；如下：</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/Dw2NBn"><img src="https://s3.ax1x.com/2020/11/26/Dw2NBn.png" alt="Dw2NBn.png"></a></p>
<p>因为我们之前经过传入static使is_page为true，所以这里直接进行$where赋值；看到语句中是否有一处无法理解？{$wpdb-&gt;posts};这个变量，如果我们仔细观察，会发现是wordpressdatabase的一个简写；那么猜想和wordpress的数据库有关系，实际上是确实有关系的，其表达的是一个表名；看如下mysql数据库中的查询结果结合上述的sql语句就可知道；</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/Dw2sc4"><img src="https://s3.ax1x.com/2020/11/26/Dw2sc4.png" alt="Dw2sc4.png"></a></p>
<p>不难理解；是一个wp_posts的表名；那么where变量就很好理解了；审计代码会发现代码对$q的属性进行了多个if判断，如果$q的属性存在的话，就将该属性用相应的sql语句进行赋值给where，每个属性对应的sql语句都不一样，具体的师傅们可以自己审计源码，我审计的结果是其对应得sql语句不一样；那么我们对应得is_page属性对应的where参量的sql语句处理的是在wp_posts表下的post_type，即我们page的类型；这里直接看sql语句就可懂(type);那么继续回溯我们的orderby参数；可以追溯到如下函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( ! <span class="keyword">empty</span>( $orderby ) ) &#123;   <span class="comment">////在2882行</span></span><br><span class="line">	$orderby = <span class="string">&#x27;ORDER BY &#x27;</span> . $orderby;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( <span class="keyword">empty</span>( $orderby ) ) &#123;    <span class="comment">////在2330行</span></span><br><span class="line">					$orderby = <span class="string">&quot;<span class="subst">&#123;$wpdb-&gt;posts&#125;</span>.post_date &quot;</span> . $q[<span class="string">&#x27;order&#x27;</span>];</span><br><span class="line">				&#125; <span class="keyword">elseif</span> ( ! <span class="keyword">empty</span>( $q[<span class="string">&#x27;order&#x27;</span>] ) ) &#123;</span><br><span class="line">					$orderby .= <span class="string">&quot; <span class="subst">&#123;$q[&#x27;order&#x27;]&#125;</span>&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>所以我们可以看到首先给其赋值为wp_posts.post_data+’xxxx’;然后再后续对其进行ORDER BY 拼接；又因为我们传入的参数中有个order=asc，已经被写入了环境变量中，所以这里直接调用；这之所以会直接调用order实际上也是因为$q的原因，我在代码的一处注释中发现了如下信息：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* @param <span class="keyword">array</span>  $q      Query variables.</span><br></pre></td></tr></table></figure>

<p>这里不难发现，我们的$q 是一个数组类型，并且是我们查询变量的”汇总”，那么我们调用查询变量中的order也就可以完全自动调用我们传入的order参数，即asc；</p>
<p>所以综上的回溯，我们request的最后拼接语句就为：</p>
<p><code>SELECT wp_posts.* FROM wp_posts WHERE 1=1 and post.type= &#39;page&#39;ORDER BY post.data ASC</code>;</p>
<p>下面继续从我们的数据库中的wp_posts中研究，我将其全部爆库，发现里面存在的内容为我们文章的信息和我们的文章类型还有一些其他的信息；当我们同时查询guid和post_type的时候，我们发现数据库中页面和类型是同时存储得；如下图:</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/Dw20hT"><img src="https://s3.ax1x.com/2020/11/26/Dw20hT.png" alt="Dw20hT.png"></a></p>
<p>这里post是指的是我们的文章，那么我们创建的页面也就是我们后面type对应的page类型；当我们三个一起列出来的时候；如下图：</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/Dw2lh8"><img src="https://s3.ax1x.com/2020/11/26/Dw2lh8.png" alt="Dw2lh8.png"></a></p>
<p>已经很显然了；我们的文章或者页面的信息，是按照type进行分类的，后面是跟着我们的status，也就是我们页面设置的状态，可以看到我们里面有些设置了private；这属于私有的页面，我们其他用户在网站上是无法进行直接访问的；说到这里后我们再次回顾我们之前的审计情况，有一处is_page的地方，我们在之前的赋值statuc和order使程序将其赋值为true；又因为其是true，再次导致了程序直接将其按照page整体来带入sql语句进行查询，那么就会反观上面的sql语句，就会列出我们所有的page页面；直接看sql语句也可以，我也在本地进行了一次复现查询；如下图：</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/Dw2D9U"><img src="https://s3.ax1x.com/2020/11/26/Dw2D9U.png" alt="Dw2D9U.png"></a></p>
<p>sql语句直接列出了我们page在数据库中的内容；也即是列出了我们所有的page；实验如下图，因为我页面有数据，所以这里sql查询出来的语句不太好观察；具体的可以看之前的几个图，列出了ID，也就是自然列处了我们的page页面的内容，并将其排列；自然的情况下如果我们不加order by的话，那么是按照我们的设置的页面隐私性来由隐私到公共排列的，通过排序是3 6 2 12的顺序就可以证明，我3的页面设置为需要密码，6为私有，其他两个为公共；如下图：</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/Dw2wNV"><img src="https://s3.ax1x.com/2020/11/26/Dw2wNV.png" alt="Dw2wNV.png"></a></p>
<p>同样我列出了时间和page的关系，也证明了不是按照时间顺序排列的；（结合之前得查询ID得结果得到得结论）</p>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/Dw239S"><img src="https://s3.ax1x.com/2020/11/26/Dw239S.png" alt="Dw239S.png"></a></p>
<p>但是我们这里漏洞要利用的sql是需要按照date进行升序排列，具体原因后面细说；</p>
<p>分析完了posts的结果，我们继续回到漏洞点；</p>
<p>因为我们已经回溯清楚posts的内容，对于我来说这里就是四个页面，不同的人要根据不同页面的情况来视；这里页面的post[0]自然是我们的页面首位，因为最早发布的页面，肯定是我们的原始页面也就是 HelloWord；其属性为public；剩下的页面也就是我们自己设置的，属性也是由我们自己定义的；继续向下审计代码；</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( ! <span class="keyword">empty</span>( <span class="keyword">$this</span>-&gt;posts ) &amp;&amp; ( <span class="keyword">$this</span>-&gt;is_single || <span class="keyword">$this</span>-&gt;is_page ) ) &#123;</span><br><span class="line">			$status = get_post_status( <span class="keyword">$this</span>-&gt;posts[<span class="number">0</span>] );</span><br><span class="line">			<span class="keyword">if</span> ( <span class="string">&#x27;attachment&#x27;</span> === <span class="keyword">$this</span>-&gt;posts[<span class="number">0</span>]-&gt;post_type &amp;&amp; <span class="number">0</span> === (<span class="keyword">int</span>) <span class="keyword">$this</span>-&gt;posts[<span class="number">0</span>]-&gt;post_parent ) &#123;</span><br><span class="line">				<span class="keyword">$this</span>-&gt;is_page       = <span class="literal">false</span>;</span><br><span class="line">				<span class="keyword">$this</span>-&gt;is_single     = <span class="literal">true</span>;</span><br><span class="line">				<span class="keyword">$this</span>-&gt;is_attachment = <span class="literal">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			$post_status_obj = get_post_status_object( $status );</span><br><span class="line"></span><br><span class="line">			<span class="comment">// If the post_status was specifically requested, let it pass through.</span></span><br><span class="line">			<span class="keyword">if</span> ( ! $post_status_obj-&gt;public &amp;&amp; ! in_array( $status, $q_status ) ) &#123;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> ( ! is_user_logged_in() ) &#123;</span><br><span class="line">					<span class="comment">// User must be logged in to view unpublished posts.</span></span><br><span class="line">					<span class="keyword">$this</span>-&gt;posts = <span class="keyword">array</span>();</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					<span class="keyword">if</span> ( $post_status_obj-&gt;protected ) &#123;</span><br><span class="line">						<span class="comment">// User must have edit permissions on the draft to preview.</span></span><br><span class="line">						<span class="keyword">if</span> ( ! current_user_can( $edit_cap, <span class="keyword">$this</span>-&gt;posts[<span class="number">0</span>]-&gt;ID ) ) &#123;</span><br><span class="line">							<span class="keyword">$this</span>-&gt;posts = <span class="keyword">array</span>();</span><br><span class="line">						&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">							<span class="keyword">$this</span>-&gt;is_preview = <span class="literal">true</span>;</span><br><span class="line">							<span class="keyword">if</span> ( <span class="string">&#x27;future&#x27;</span> != $status ) &#123;</span><br><span class="line">								<span class="keyword">$this</span>-&gt;posts[<span class="number">0</span>]-&gt;post_date = current_time( <span class="string">&#x27;mysql&#x27;</span> );</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;</span><br><span class="line">					&#125; <span class="keyword">elseif</span> ( $post_status_obj-&gt;private ) &#123;</span><br><span class="line">						<span class="keyword">if</span> ( ! current_user_can( $read_cap, <span class="keyword">$this</span>-&gt;posts[<span class="number">0</span>]-&gt;ID ) ) &#123;</span><br><span class="line">							<span class="keyword">$this</span>-&gt;posts = <span class="keyword">array</span>();</span><br><span class="line">						&#125;</span><br><span class="line">					&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">						<span class="keyword">$this</span>-&gt;posts = <span class="keyword">array</span>();</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>有个关键的代码块；审计程序判断了我们的首位也页面是不是public；如果不是的话，就需要验证登陆，是public的话，就不会验证登陆；所以我们按照时间顺序进行升序排列，那么初始页面就为public，即是posts[0];那么public自然可以绕过最开始的if判断；也就可以直接把所有页面列出来；</p>

            <div class="clearfix"></div>
            <hr class="nogutter">
        </div>
        <nav class="m-pagination col-md-8 col-md-offset-2 col-sm-24" role="pagination">
    
    <a class="pull-left" href="/2020/12/02/Jsonp-hijacking/" style="float: left;">
        ← Jsonp hijacking and xss
    </a>
    
    
    <a class="pull-right" href="/2020/11/23/%E7%A5%A5%E4%BA%91web/">
        祥云web →
    </a>
    
</nav>

        <div class="col-md-8 col-md-offset-2 col-sm-24"><script type="text/javascript">
  /**
   * 搜狐畅言
   */

  /*
  document.write('<div id="SOHUCS" sid="' + window.location.pathname.slice(1) + '" ></div>');

  window.onload = function () {
    (function () {
      var appid = 'cytXXXX';
      var conf = 'prod_xxxxxxxxxxxxxxxxx';
      var width = window.innerWidth || document.documentElement.clientWidth;
      var loadJs = function (d, a, id) {
        var c = document.getElementsByTagName("head")[0] || document.head || document.documentElement;
        var b = document.createElement("script");
        b.setAttribute("type", "text/javascript");
        b.setAttribute("charset", "UTF-8");
        b.setAttribute("src", d);
        if (id) {
          b.setAttribute("id", id);
        }
        if (typeof a === "function") {
          if (window.attachEvent) {
            b.onreadystatechange = function () {
              var e = b.readyState;
              if (e === "loaded" || e === "complete") {
                b.onreadystatechange = null;
                a()
              }
            }
          } else {
            b.onload = a
          }
        }
        c.appendChild(b)
      };

      loadJs("https://changyan.sohu.com/upload/changyan.js", function () {
        window.changyan.api.config({
          appid: appid,
          conf: conf
        })
      });
    })();
  }
  */

</script>
</div>
    </div>
</section>


      
<!-- ============================ Footer =========================== -->

<footer>
    <div class="container">
            <div class="copy">
                <p>
                    &copy; 2014<script>new Date().getFullYear()>2010&&document.write("-"+new Date().getFullYear());</script>, Content By s1mple. All Rights Reserved.
                </p>
                <p>Theme By <a target="_blank" rel="noopener" href="//go.kieran.top" style="color: #767D84">Kieran</a></p>
            </div>
            <div class="social">
                <ul>
                    
                    <li><a href="https://github.com/" title="Github" target="_blank"><i class="icon-github"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="https://twitter.com/" title="Twitter" target="_blank"><i class="icon-twitter"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="https://www.facebook.com/" title="Facebook" target="_blank"><i class="icon-facebook"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="https://google.com/" title="Google-Plus" target="_blank"><i class="icon-google-plus"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="http://weibo.com/" title="Sina-Weibo" target="_blank"><i class="icon-sina-weibo"></i></a>&nbsp;</li>
                    
                </ul>
            </div>
            <div class="clearfix"> </div>
        </div>
</footer>

<!-- ============================ END Footer =========================== -->
      <!-- Load our scripts -->
<!-- Resizable 'on-demand' full-height hero -->
<script type="text/javascript">
    var resizeHero = function () {
        var hero = $(".cover,.heightblock"),
            window1 = $(window);
        hero.css({
            "height": window1.height()
        });
    };

    resizeHero();

    $(window).resize(function () {
        resizeHero();
    });
</script>
<script src="/js/plugins.min.js"></script><!-- Bootstrap core and concatenated plugins always load here -->
<script src="/js/scripts.js"></script><!-- Theme scripts -->


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$('#intro').find('img').each(function(){
  var alt = this.alt;

  if (alt){
    $(this).after('<span class="caption" style="display:none">' + alt + '</span>');
  }

  $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox" rel="gallery" />');
});
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



      
</body>
</html>
